# nginx config for api.chubby.fyi (MCP server)
#
# Place at: /etc/nginx/sites-available/api.chubby.fyi
# Symlink:  ln -s /etc/nginx/sites-available/api.chubby.fyi /etc/nginx/sites-enabled/
#
# Cloudflare SSL mode: "Full" (CF terminates public SSL; origin uses self-signed)
# Origin is firewalled to CF IPs only, so self-signed is fine.

# Rate limiting: 100 req/min per IP (uses CF-Connecting-IP)
# Burst of 20 allows short spikes without dropping requests
limit_req_zone $http_cf_connecting_ip zone=mcp_api:10m rate=100r/m;

# Concurrency limit: prevent OOM from too many simultaneous simulations
# Each simulation can peak ~200MB; 4GB box = max ~8 concurrent safely
limit_conn_zone $http_cf_connecting_ip zone=mcp_conn:10m;

server {
    listen 80;
    server_name api.chubby.fyi;

    # --- General settings ---
    client_max_body_size 1m;

    # Health check (no rate limit)
    location = /health {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
    }

    # SSE endpoint: GET /mcp
    # Critical: disable buffering for streaming, long timeout for SSE
    location = /mcp {
        limit_req zone=mcp_api burst=20 nodelay;
        limit_conn mcp_conn 8;

        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;

        # SSE: disable buffering, allow long-lived connections
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # Ensure chunked encoding works
        chunked_transfer_encoding on;

        # Disable gzip on SSE (already text/event-stream)
        gzip off;
    }

    # POST /mcp/messages (client â†’ server messages)
    location = /mcp/messages {
        limit_req zone=mcp_api burst=20 nodelay;
        limit_conn mcp_conn 8;

        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
    }

    # Widget + viewer + other static-ish endpoints
    location / {
        limit_req zone=mcp_api burst=20 nodelay;

        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
    }

    # Block direct access probes
    location ~ /\. {
        deny all;
    }
}
