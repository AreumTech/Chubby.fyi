<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Chubby Simulation Viewer</title>
  <!-- pako for decompression (local copy) -->
  <script src="/pako.min.js"></script>
  <style>
    /* =========================================================================
     * CSS Custom Properties - Privacy-First Viewer
     * Matches simulation-widget.html design tokens
     * ========================================================================= */
    :root {
      color-scheme: light dark;

      /* Typography Scale */
      --font-size-2xs: 10px;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 18px;

      /* Spacing Scale (4px grid) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;

      /* Radius Scale */
      --radius-xs: 6px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;

      /* Control Sizes */
      --control-sm: 28px;
      --control-md: 32px;
      --control-lg: 36px;
      --control-xl: 40px;
      --control-2xl: 44px;

      /* Gray scale */
      --gray-0: light-dark(#ffffff, #0d0d0d);
      --gray-50: light-dark(#f9f9f9, #131313);
      --gray-100: light-dark(#ededed, #181818);
      --gray-200: light-dark(#cdcdcd, #212121);
      --gray-300: light-dark(#afafaf, #303030);
      --gray-400: light-dark(#8f8f8f, #414141);
      --gray-500: #5d5d5d;
      --gray-600: light-dark(#414141, #8f8f8f);
      --gray-700: light-dark(#303030, #afafaf);
      --gray-1000: light-dark(#0d0d0d, #ffffff);

      /* Semantic text colors */
      --color-text: var(--gray-1000);
      --color-text-secondary: var(--gray-500);
      --color-text-tertiary: var(--gray-400);

      /* Surfaces */
      --color-surface: var(--gray-0);
      --color-surface-secondary: var(--gray-50);
      --color-surface-elevated: light-dark(#f5f5f5, #1a1a1a);

      /* Borders */
      --color-border: light-dark(rgba(13,13,13,0.1), rgba(255,255,255,0.1));
      --color-border-subtle: light-dark(rgba(13,13,13,0.06), rgba(255,255,255,0.08));

      /* Semantic */
      --color-positive: light-dark(#2d8a4e, #6db88a);
      --color-negative: light-dark(#9a6458, #c4897c);
      --color-link: light-dark(#0285ff, #60a5fa);

      /* Trajectory bands */
      --color-bar-p50: var(--gray-700);
      --color-bar-p75: light-dark(#c5c5c5, #4a4a4a);
      --color-bar-p10: light-dark(#a0a0a0, #656565);
      --color-bar-bg: light-dark(#ededed, #252525);

      /* Negative net worth */
      --color-bar-negative: light-dark(#e8d4d0, #3d2a27);
      --color-bar-negative-border: var(--color-negative);

      /* Focus ring */
      --focus-ring: 0 0 0 2px var(--color-link);
    }

    /* Fallback for older browsers */
    :root:not([data-theme="dark"]) {
      --gray-0: #ffffff;
      --gray-50: #f9f9f9;
      --gray-100: #ededed;
      --gray-200: #cdcdcd;
      --gray-300: #afafaf;
      --gray-400: #8f8f8f;
      --gray-600: #414141;
      --gray-700: #303030;
      --gray-1000: #0d0d0d;
      --color-text: #0d0d0d;
      --color-text-secondary: #5d5d5d;
      --color-text-tertiary: #8f8f8f;
      --color-surface: #ffffff;
      --color-surface-secondary: #f9f9f9;
      --color-surface-elevated: #f5f5f5;
      --color-border: rgba(13,13,13,0.1);
      --color-border-subtle: rgba(13,13,13,0.06);
      --color-positive: #2d8a4e;
      --color-negative: #9a6458;
      --color-link: #0285ff;
      --color-bar-p50: #303030;
      --color-bar-p75: #c5c5c5;
      --color-bar-p10: #a0a0a0;
      --color-bar-bg: #ededed;
      --color-bar-negative: #e8d4d0;
      --color-bar-negative-border: #9a6458;
      --focus-ring: 0 0 0 2px #0285ff;
    }

    :root[data-theme="dark"] {
      --gray-0: #0d0d0d;
      --gray-50: #131313;
      --gray-100: #181818;
      --gray-200: #212121;
      --gray-300: #303030;
      --gray-400: #414141;
      --gray-600: #8f8f8f;
      --gray-700: #afafaf;
      --gray-1000: #ffffff;
      --color-text: #ffffff;
      --color-text-secondary: #5d5d5d;
      --color-text-tertiary: #414141;
      --color-surface: #0d0d0d;
      --color-surface-secondary: #131313;
      --color-surface-elevated: #1a1a1a;
      --color-border: rgba(255,255,255,0.1);
      --color-border-subtle: rgba(255,255,255,0.08);
      --color-positive: #6db88a;
      --color-negative: #c4897c;
      --color-link: #60a5fa;
      --color-bar-p50: #afafaf;
      --color-bar-p75: #4a4a4a;
      --color-bar-p10: #656565;
      --color-bar-bg: #252525;
      --color-bar-negative: #3d2a27;
      --color-bar-negative-border: #c4897c;
      --focus-ring: 0 0 0 2px #60a5fa;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", sans-serif;
      font-size: var(--font-size-sm);
      line-height: 1.5;
      color: var(--color-text);
      background: var(--color-surface);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* =========================================================================
     * PRIVACY BANNER - Always visible
     * ========================================================================= */
    .privacy-banner {
      background: var(--color-surface-elevated);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-3) var(--space-4);
      text-align: center;
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .privacy-banner-icon {
      margin-right: var(--space-2);
    }

    .privacy-banner-text {
      display: inline;
    }

    .privacy-banner-emphasis {
      color: var(--color-text);
      font-weight: 500;
    }

    /* =========================================================================
     * CONTAINER
     * ========================================================================= */
    .container {
      flex: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: var(--space-5);
      width: 100%;
    }

    /* =========================================================================
     * HEADER
     * ========================================================================= */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .header-brand {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .header-tag {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
    }

    /* =========================================================================
     * LOADING STATE
     * ========================================================================= */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-6);
      min-height: 300px;
      text-align: center;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-link);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--space-4);
    }

    .loading-text {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* =========================================================================
     * ERROR STATE
     * ========================================================================= */
    .error-state {
      padding: var(--space-6);
      text-align: center;
    }

    .error-title {
      font-size: var(--font-size-lg);
      color: var(--color-negative);
      margin-bottom: var(--space-3);
    }

    .error-message {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    .error-hint {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      padding: var(--space-3);
      background: var(--color-surface-elevated);
      border-radius: var(--radius-sm);
    }

    /* =========================================================================
     * WIDGET CONTENT - Embedded iframe or inline styles
     * ========================================================================= */
    #widget-container {
      /* Container for widget content */
    }

    /* =========================================================================
     * DURATION SECTION
     * ========================================================================= */
    .duration {
      margin-bottom: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border-subtle);
    }

    .duration-label {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .duration-headline {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .duration-details {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .duration-assets {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
    }

    /* =========================================================================
     * SCENARIO SECTION
     * ========================================================================= */
    .scenario {
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      overflow: hidden;
    }

    .scenario-section {
      padding: var(--space-3) var(--space-4);
    }

    .scenario-section + .scenario-section {
      border-top: 1px solid var(--color-border-subtle);
    }

    .scenario-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .start-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-2);
    }

    .start-item-label {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
    }

    .start-item-value {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text);
    }

    .events {
      display: flex;
      flex-direction: column;
    }

    .event {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      min-height: 28px;
      padding: var(--space-1) 0;
    }

    .event-icon {
      width: var(--space-4);
      text-align: center;
    }

    .event-age {
      font-weight: 500;
      color: var(--color-text);
      min-width: 52px;
    }

    .event-label {
      color: var(--color-text-secondary);
      flex: 1;
    }

    .event-change {
      color: var(--color-text-tertiary);
      font-weight: 500;
    }

    /* =========================================================================
     * TRAJECTORY SECTION
     * ========================================================================= */
    .trajectory {
      margin-bottom: var(--space-4);
    }

    .traj-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .traj-row {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      min-height: 24px;
      padding: 2px var(--space-2);
      margin: 0 calc(-1 * var(--space-2));
    }

    .traj-age {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      min-width: 46px;
    }

    .traj-bar-container {
      flex: 1;
      height: var(--space-4);
      background: var(--color-bar-bg);
      border-radius: var(--radius-xs);
      position: relative;
      overflow: visible;
    }

    .traj-bar-range {
      position: absolute;
      height: 100%;
      background: var(--color-bar-p75);
      border-radius: var(--radius-xs);
    }

    .traj-bar-p50 {
      position: absolute;
      height: 100%;
      width: 3px;
      background: var(--color-bar-p50);
      border-radius: 1px;
      z-index: 2;
      transform: translateX(-1.5px);
    }

    .traj-value {
      font-size: var(--font-size-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      min-width: 48px;
      text-align: right;
    }

    .traj-legend {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-2);
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
    }

    .traj-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .traj-legend-swatch {
      width: var(--space-3);
      height: var(--space-2);
      border-radius: 2px;
    }

    .traj-legend-swatch.range { background: var(--color-bar-p75); }
    .traj-legend-swatch.p50 { background: var(--color-bar-p50); width: 3px; }

    /* =========================================================================
     * FOOTER
     * ========================================================================= */
    .footer {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      .start-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .container {
        padding: var(--space-4);
      }
    }
  </style>
</head>
<body>
  <!-- Privacy Banner - Always visible -->
  <div class="privacy-banner">
    <span class="privacy-banner-icon">ðŸ”’</span>
    <span class="privacy-banner-text">
      <span class="privacy-banner-emphasis">Your data never left your browser.</span>
      This visualization exists only here. Refreshing clears everything.
    </span>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <span class="header-brand">Chubby</span>
      <span class="header-tag">Educational simulation</span>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading simulation...</div>
    </div>

    <!-- Error State (hidden by default) -->
    <div id="error-state" class="error-state" style="display: none;">
      <div class="error-title">Unable to Load</div>
      <div id="error-message" class="error-message"></div>
      <div class="error-hint">
        This viewer reads data from the URL fragment. If you navigated here directly,
        the simulation data may be missing. Try running a new simulation in Claude.
      </div>
    </div>

    <!-- Widget Content (hidden until loaded) -->
    <div id="widget-container" style="display: none;"></div>
  </div>

  <script>
    // =========================================================================
    // Theme Detection
    // =========================================================================

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme || 'light');
      document.documentElement.style.colorScheme = theme || 'light';
    }

    function detectTheme() {
      if (window.matchMedia) {
        const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(dark ? 'dark' : 'light');
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          applyTheme(e.matches ? 'dark' : 'light');
        });
      }
    }

    detectTheme();

    // =========================================================================
    // Format Utilities
    // =========================================================================

    function fmt(v) {
      if (v == null) return 'â€”';
      const sign = v < 0 ? '-' : '';
      const abs = Math.abs(v);
      if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
      if (abs >= 1e3) return sign + '$' + Math.round(abs / 1e3) + 'K';
      return sign + '$' + Math.round(abs);
    }

    function fmtYr(v) {
      if (v == null) return 'â€”';
      const sign = v < 0 ? '-' : '';
      const abs = Math.abs(v);
      if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
      if (abs >= 1e3) return sign + '$' + Math.round(abs / 1e3) + 'K';
      return sign + '$' + Math.round(abs);
    }

    // =========================================================================
    // Render Functions
    // =========================================================================

    function renderDuration(data) {
      const pd = data.planDuration;
      const horizonMonths = data.inputs?.horizonMonths || 360;
      const currentAge = data.inputs?.currentAge || 35;
      const horizonAge = currentAge + Math.floor(horizonMonths / 12);

      let saturated = pd?.horizonSaturated ?? false;
      if (!pd) {
        const runwayP50 = data.mc?.runwayP50 ?? horizonMonths;
        saturated = runwayP50 >= horizonMonths;
      }

      const p50Assets = data.mc?.finalNetWorthP50 || 0;

      let html = '<div class="duration">';
      html += '<div class="duration-label">Plan Coverage</div>';

      if (saturated) {
        html += '<div class="duration-headline">This plan stays funded through Age ' + horizonAge + '</div>';
        html += '<div class="duration-details">(end of simulation)</div>';
        if (p50Assets > 0) {
          html += '<div class="duration-assets">Typical assets at that age: <strong>~' + fmt(p50Assets) + '</strong></div>';
        }
      } else {
        const mostAge = pd?.mostPathsAge || (currentAge + Math.floor((data.mc?.runwayP50 || horizonMonths) / 12));
        html += '<div class="duration-headline">This plan runs out around Age ' + mostAge + '</div>';
        html += '<div class="duration-details">in a typical outcome</div>';
      }

      html += '</div>';
      return html;
    }

    function renderScenario(data) {
      const inp = data.inputs || {};
      const sch = data.schedule || {};

      let html = '<div class="scenario">';

      // Starting point
      html += '<div class="scenario-section">';
      html += '<div class="scenario-title">Starting Point</div>';
      html += '<div class="start-grid">';
      html += '<div><div class="start-item-label">Age</div><div class="start-item-value">' + (inp.currentAge || 'â€”') + '</div></div>';
      html += '<div><div class="start-item-label">Assets</div><div class="start-item-value">' + fmt(inp.investableAssets) + '</div></div>';
      html += '<div><div class="start-item-label">Income</div><div class="start-item-value">' + fmtYr(inp.expectedIncome) + '</div></div>';
      html += '<div><div class="start-item-label">Spending</div><div class="start-item-value">' + fmtYr(inp.annualSpending) + '</div></div>';
      html += '</div></div>';

      // Events
      const events = sch.scheduledEvents || [];
      if (events.length > 0) {
        html += '<div class="scenario-section">';
        html += '<div class="scenario-title">Scheduled Events</div>';
        html += '<div class="events">';
        events.forEach(e => {
          html += '<div class="event">';
          html += '<span class="event-icon">' + (e.icon || 'ðŸ“…') + '</span>';
          html += '<span class="event-age">Age ' + e.age + '</span>';
          html += '<span class="event-label">' + e.label + '</span>';
          html += '<span class="event-change">' + e.change + '</span>';
          html += '</div>';
        });
        html += '</div></div>';
      }

      html += '</div>';
      return html;
    }

    function renderTrajectory(data) {
      const currentAge = data.inputs?.currentAge || 35;
      const horizonMonths = data.inputs?.horizonMonths || 360;
      const endAge = currentAge + Math.floor(horizonMonths / 12);
      const trajectory = data.netWorthTrajectory || data.mc?.netWorthTrajectory || [];

      if (trajectory.length === 0) {
        return '<div class="trajectory"><div class="traj-title">Trajectory</div><div style="color: var(--color-text-tertiary);">No trajectory data available</div></div>';
      }

      // Sample ages
      const horizonYears = endAge - currentAge;
      const interval = horizonYears > 50 ? 10 : 5;
      const ages = new Set([currentAge, endAge]);
      const firstAge = Math.ceil(currentAge / interval) * interval;
      for (let a = firstAge; a <= endAge; a += interval) ages.add(a);
      const sortedAges = [...ages].sort((a, b) => a - b);

      // Find max for scaling
      let maxP50 = 0;
      trajectory.forEach(pt => {
        const p50 = pt.p50 || 0;
        if (p50 > maxP50) maxP50 = p50;
      });
      const maxVal = maxP50 > 0 ? maxP50 * 1.1 : 1;

      let html = '<div class="trajectory">';
      html += '<div class="traj-title">What Happens to Your Money</div>';

      sortedAges.forEach(age => {
        const yearOffset = age - currentAge;
        const monthOffset = yearOffset * 12;

        // Find closest point
        let pt = trajectory[0] || { p10: 0, p50: 0, p75: 0 };
        let minDiff = Math.abs((trajectory[0]?.monthOffset || trajectory[0]?.month || 0) - monthOffset);
        trajectory.forEach(p => {
          const diff = Math.abs((p.monthOffset || p.month || 0) - monthOffset);
          if (diff < minDiff) { minDiff = diff; pt = p; }
        });

        const p10 = Math.max(0, pt.p10 || 0);
        const p50 = Math.max(0, pt.p50 || 0);
        const pct10 = Math.round((p10 / maxVal) * 100);
        const pct50 = Math.min(100, Math.round((p50 / maxVal) * 100));
        const rangeWidth = Math.max(0, pct50 - pct10);

        html += '<div class="traj-row">';
        html += '<span class="traj-age">' + age + '</span>';
        html += '<div class="traj-bar-container">';
        html += '<div class="traj-bar-range" style="left:' + pct10 + '%; width:' + rangeWidth + '%"></div>';
        html += '<div class="traj-bar-p50" style="left:' + pct50 + '%"></div>';
        html += '</div>';
        html += '<span class="traj-value">' + fmt(p50) + '</span>';
        html += '</div>';
      });

      html += '<div class="traj-legend">';
      html += '<div class="traj-legend-item"><span class="traj-legend-swatch range"></span> Conservative â†’ Typical</div>';
      html += '<div class="traj-legend-item"><span class="traj-legend-swatch p50"></span> Median (P50)</div>';
      html += '</div>';
      html += '</div>';

      return html;
    }

    function renderFooter(data) {
      const horizonMonths = data.inputs?.horizonMonths || 360;
      const horizonAge = (data.inputs?.currentAge || 35) + Math.floor(horizonMonths / 12);

      let html = '<div class="footer">';
      html += '<span>' + (data.runId || 'â€”') + '</span>';
      html += '<span>through Age ' + horizonAge + '</span>';
      html += '<span>' + (data.pathsRun || 100) + ' paths</span>';
      html += '</div>';
      return html;
    }

    function renderWidget(data) {
      let html = '';
      html += renderDuration(data);
      html += renderScenario(data);
      html += renderTrajectory(data);
      html += renderFooter(data);
      return html;
    }

    // =========================================================================
    // Main Initialization
    // =========================================================================

    function showError(message) {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-state').style.display = 'block';
    }

    function showWidget(data) {
      document.getElementById('loading-state').style.display = 'none';
      const container = document.getElementById('widget-container');
      container.innerHTML = renderWidget(data);
      container.style.display = 'block';
    }

    function init() {
      // Read payload from URL fragment
      // CRITICAL: The fragment (#...) is NEVER sent to the server
      const hash = window.location.hash;

      if (!hash || hash.length < 2) {
        showError('No simulation data in URL. The fragment payload is missing.');
        return;
      }

      // Parse the hash - expected format: #d=<base64-compressed-payload>
      const params = new URLSearchParams(hash.slice(1));
      const payload = params.get('d');

      if (!payload) {
        showError('Invalid URL format. Expected #d=<payload>');
        return;
      }

      try {
        // Decode base64 (handle both standard and URL-safe base64)
        const std = payload.replace(/-/g, '+').replace(/_/g, '/');
        const padded = std + '='.repeat((4 - std.length % 4) % 4);
        const binary = atob(padded);

        // Convert to Uint8Array
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }

        // Decompress with pako
        const decompressed = pako.inflate(bytes, { to: 'string' });

        // Parse JSON
        const data = JSON.parse(decompressed);

        console.log('[Chubby Viewer] Data loaded from fragment:', data.runId || 'unknown');

        // Render widget
        showWidget(data);

      } catch (err) {
        console.error('[Chubby Viewer] Failed to parse payload:', err);
        showError('Failed to decompress simulation data: ' + err.message);
      }
    }

    // Start when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
