<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Chubby Simulation Summary</title>
  <style>
    /* =========================================================================
     * CSS Custom Properties - Aligned with OpenAI Apps SDK UI
     * ========================================================================= */
    /* Keep document canvas neutral - don't trigger UA dark canvas painting */
    html {
      color-scheme: normal;
      background: transparent;
    }

    :root {

      /* =====================================================================
       * Typography Scale (Apps SDK aligned)
       * lg=18px, md=16px, sm/base=14px, xs=12px, 2xs=10px
       * ===================================================================== */
      --font-size-2xs: 10px;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 18px;

      /* =====================================================================
       * Spacing Scale (4px grid)
       * ===================================================================== */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;

      /* =====================================================================
       * Radius Scale (OpenAI Apps SDK aligned)
       * From reference/apps-sdk-ui/src/styles/variables-semantic.css
       * ===================================================================== */
      --radius-2xs: 2px;
      --radius-xs: 4px;
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 10px;
      --radius-xl: 12px;
      --radius-2xl: 16px;
      --radius-3xl: 20px;
      --radius-4xl: 24px;

      /* =====================================================================
       * Control Sizes (touch targets)
       * Minimum mobile touch target: 44px (--control-2xl)
       * ===================================================================== */
      --control-sm: 28px;
      --control-md: 32px;
      --control-lg: 36px;
      --control-xl: 40px;
      --control-2xl: 44px;

      /* Gray scale (from Apps SDK) */
      --gray-0: light-dark(#ffffff, #0d0d0d);
      --gray-50: light-dark(#f9f9f9, #131313);
      --gray-100: light-dark(#ededed, #181818);
      --gray-200: light-dark(#cdcdcd, #212121);
      --gray-300: light-dark(#afafaf, #303030);
      --gray-400: light-dark(#8f8f8f, #414141);
      --gray-500: #5d5d5d;
      --gray-600: light-dark(#414141, #8f8f8f);
      --gray-700: light-dark(#303030, #afafaf);
      --gray-1000: light-dark(#0d0d0d, #ffffff);

      /* Semantic text colors */
      --color-text: var(--gray-1000);
      --color-text-secondary: var(--gray-500);
      --color-text-tertiary: var(--gray-400);
      --color-text-muted: var(--gray-400);

      /* Surfaces */
      --color-surface: var(--gray-0);
      --color-surface-secondary: var(--gray-50);
      --color-surface-elevated: light-dark(#f5f5f5, #1a1a1a);
      --color-background: var(--color-surface);
      --color-surface-hover: light-dark(#f1f1f1, #1f1f1f);
      --color-surface-active: light-dark(#e8e8e8, #262626);

      /* Borders - using alpha */
      --color-border: light-dark(rgba(13,13,13,0.1), rgba(255,255,255,0.1));
      --color-border-subtle: light-dark(rgba(13,13,13,0.06), rgba(255,255,255,0.08));

      /* Semantic - muted palette */
      --color-positive: light-dark(#2d8a4e, #6db88a);
      --color-negative: light-dark(#9a6458, #c4897c);
      --color-link: light-dark(#0285ff, #60a5fa);
      --color-success: light-dark(#2d8a4e, #6db88a);

      /* Trajectory bands - distinct visual layers */
      --color-bar-p50: var(--gray-700);
      --color-bar-p75: light-dark(#c5c5c5, #4a4a4a);
      --color-bar-p10: light-dark(#a0a0a0, #656565);
      --color-bar-bg: light-dark(#ededed, #252525);

      /* Negative net worth - visual indicator */
      --color-bar-negative: light-dark(#e8d4d0, #3d2a27);
      --color-bar-negative-border: var(--color-negative);

      /* Focus ring */
      --focus-ring: 0 0 0 2px var(--color-link);

      /* Account type colors for stacked bar */
      --color-account-cash: var(--gray-400);
      --color-account-taxable: var(--color-link);
      --color-account-tax-deferred: light-dark(#7c3aed, #a78bfa);
      --color-account-roth: var(--color-positive);

    }

    /* Fallback for older browsers */
    :root:not([data-theme="dark"]) {
      --gray-0: #ffffff;
      --gray-50: #f9f9f9;
      --gray-100: #ededed;
      --gray-200: #cdcdcd;
      --gray-300: #afafaf;
      --gray-400: #8f8f8f;
      --gray-600: #414141;
      --gray-700: #303030;
      --gray-1000: #0d0d0d;
      --color-text: #0d0d0d;
      --color-text-secondary: #5d5d5d;
      --color-text-tertiary: #8f8f8f;
      --color-text-muted: #8f8f8f;
      --color-surface: #ffffff;
      --color-surface-secondary: #f9f9f9;
      --color-surface-elevated: #f5f5f5;
      --color-background: #ffffff;
      --color-surface-hover: #f1f1f1;
      --color-surface-active: #e8e8e8;
      --color-border: rgba(13,13,13,0.1);
      --color-border-subtle: rgba(13,13,13,0.06);
      --color-positive: #2d8a4e;
      --color-negative: #9a6458;
      --color-link: #0285ff;
      --color-success: #2d8a4e;
      --color-bar-p50: #303030;
      --color-bar-p75: #c5c5c5;
      --color-bar-p10: #a0a0a0;
      --color-bar-bg: #ededed;
      --color-bar-negative: #e8d4d0;
      --color-bar-negative-border: #9a6458;
      --focus-ring: 0 0 0 2px #0285ff;
      --color-account-cash: #8f8f8f;
      --color-account-taxable: #0285ff;
      --color-account-tax-deferred: #7c3aed;
      --color-account-roth: #2d8a4e;
    }

    :root[data-theme="dark"] {
      --gray-0: #0d0d0d;
      --gray-50: #131313;
      --gray-100: #181818;
      --gray-200: #212121;
      --gray-300: #303030;
      --gray-400: #414141;
      --gray-600: #8f8f8f;
      --gray-700: #afafaf;
      --gray-1000: #ffffff;
      --color-text: #ffffff;
      --color-text-secondary: #9a9a9a;
      --color-text-tertiary: #6b6b6b;
      --color-text-muted: #6b6b6b;
      --color-surface: #0d0d0d;
      --color-surface-secondary: #131313;
      --color-surface-elevated: #1a1a1a;
      --color-background: #0d0d0d;
      --color-surface-hover: #1f1f1f;
      --color-surface-active: #262626;
      --color-border: rgba(255,255,255,0.1);
      --color-border-subtle: rgba(255,255,255,0.08);
      --color-positive: #6db88a;
      --color-negative: #c4897c;
      --color-link: #60a5fa;
      --color-success: #6db88a;
      --color-bar-p50: #afafaf;
      --color-bar-p75: #4a4a4a;
      --color-bar-p10: #656565;
      --color-bar-bg: #252525;
      --color-bar-negative: #3d2a27;
      --color-bar-negative-border: #c4897c;
      --focus-ring: 0 0 0 2px #60a5fa;
      --color-account-cash: #414141;
      --color-account-taxable: #60a5fa;
      --color-account-tax-deferred: #a78bfa;
      --color-account-roth: #6db88a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", sans-serif;
      font-size: var(--font-size-sm);
      line-height: 1.5;
      color: var(--color-text);
      color-scheme: light dark; /* Enable light-dark() inside body subtree */
      background: transparent;
      margin: 0;
    }

    .widget {
      /* OpenAI Apps SDK Card padding: 20px */
      padding: 20px !important;
      padding-top: calc(20px + env(safe-area-inset-top, 0px)) !important;
      padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px)) !important;
      padding-left: calc(20px + env(safe-area-inset-left, 0px)) !important;
      padding-right: calc(20px + env(safe-area-inset-right, 0px)) !important;
      width: 100%;
      max-width: 100%; /* Fill container width - host handles constraints */
      box-sizing: border-box;
      /* Rounded card styling */
      border-radius: var(--radius-3xl); /* 20px */
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Display mode variations */
    .widget[data-display-mode="inline"] {
      /* Inline mode: fill available width, ChatGPT container handles constraints */
      max-width: 100%;
    }

    .widget[data-display-mode="pip"] {
      /* PiP: use available space */
      max-width: 100%;
    }

    .widget[data-display-mode="fullscreen"] {
      /* Fullscreen: wider content, more padding */
      max-width: 800px;
      padding: var(--space-5);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* =========================================================================
     * HEADER - Hidden by default for ChatGPT (OpenAI guideline: no logos)
     * ChatGPT appends branding automatically
     * ========================================================================= */
    .header {
      display: none; /* Hidden by default in ChatGPT inline mode */
    }

    /* Show header only in standalone/fullscreen mode */
    .widget[data-display-mode="fullscreen"] .header,
    .widget[data-display-mode="pip"] .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .header-brand {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .header-tag {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
    }

    /* =========================================================================
     * PLAN DURATION - Primary metric, hero section
     * ========================================================================= */
    .duration {
      margin-bottom: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-xl);
      border: 1px solid var(--color-border-subtle);
    }

    .duration-label {
      font-size: var(--font-size-xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .duration-question {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-3);
    }

    .duration-answer {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    /* Outcome list (constrained case) */
    .duration-outcomes {
      list-style: none;
      padding: 0;
      margin: 0 0 var(--space-2) 0;
    }

    .duration-outcomes li {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      padding: var(--space-1) 0;
    }

    .duration-outcomes li::before {
      content: '•';
      color: var(--color-text-tertiary);
    }

    .duration-outcomes .age {
      font-weight: 600;
      color: var(--color-text);
    }

    .duration-outcomes .typical {
      font-weight: 500;
    }

    /* Saturated message */
    .duration-saturated {
      margin-bottom: var(--space-2);
    }

    .duration-saturated-headline {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .duration-saturated-details {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .duration-horizon-note {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-3);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-subtle);
      line-height: 1.5;
    }

    .duration-outcome-line {
      padding: var(--space-1) 0;
    }

    .duration-saturated-assets {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
    }

    .duration-multiplier {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-1);
    }

    .duration-outcome-note {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-subtle);
    }

    .duration-note {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      padding-top: var(--space-2);
      margin-top: var(--space-2);
      border-top: 1px solid var(--color-border-subtle);
      line-height: 1.4;
    }

    .duration-cause {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-subtle);
    }

    /* =========================================================================
     * SCENARIO - Starting point + Events
     * ========================================================================= */
    .scenario {
      background: var(--color-surface-secondary);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-4);
      overflow: hidden;
    }

    .scenario-section {
      padding: var(--space-3) var(--space-4);
    }

    .scenario-section + .scenario-section {
      border-top: 1px solid var(--color-border-subtle);
    }

    .scenario-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    /* Starting point grid */
    .start-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-2);
    }

    .start-item-label {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
    }

    .start-item-value {
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text);
    }

    /* Events list */
    .events {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .event {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      min-height: 28px;
      padding: var(--space-1) 0;
    }

    .event-icon {
      width: var(--space-4);
      text-align: center;
      font-size: var(--font-size-xs);
    }

    .event-age {
      font-weight: 500;
      color: var(--color-text);
      min-width: 52px;
    }

    .event-label {
      color: var(--color-text-secondary);
      flex: 1;
    }

    .event-change {
      color: var(--color-text-tertiary);
      font-weight: 500;
    }

    .events-empty {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      padding: var(--space-2) 0;
    }

    .events-empty-note {
      color: var(--color-text-tertiary);
    }

    /* =========================================================================
     * TRAJECTORY - Bands showing P10/P50/P75
     * ========================================================================= */
    .trajectory {
      margin-bottom: var(--space-4);
    }

    .traj-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .traj-row {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      min-height: 24px;
      padding: 2px var(--space-2);
      cursor: pointer;
      border-radius: var(--radius-md);
      margin: 0 calc(-1 * var(--space-2));
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .traj-row:hover,
    .traj-row:active {
      background: var(--color-surface-secondary);
    }

    .traj-row:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* Even larger touch targets on fullscreen */
    .widget[data-display-mode="fullscreen"] .traj-row {
      min-height: 52px;
    }

    .traj-age {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      min-width: 46px;
    }

    .traj-bar-container {
      flex: 1;
      height: var(--space-4);
      background: var(--color-bar-bg);
      border-radius: var(--radius-sm);
      position: relative;
      overflow: visible; /* Allow P10 marker to show fully */
    }

    /* Boxplot style: P10→P75 range (full uncertainty band) */
    .traj-bar-range {
      position: absolute;
      height: 100%;
      background: var(--color-bar-p75);
      border-radius: var(--radius-sm);
    }

    /* P50 marker (vertical line showing median within the P10→P75 range) */
    .traj-bar-p50 {
      position: absolute;
      height: 100%;
      width: 3px;
      background: var(--color-bar-p50);
      border-radius: 1px;
      z-index: 2;
      transform: translateX(-1.5px);
    }

    .traj-value {
      font-size: var(--font-size-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      min-width: 48px;
      text-align: right;
    }

    .traj-inspect {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      opacity: 0;
      transition: opacity 0.15s ease;
      margin-left: var(--space-1);
      width: var(--space-4);
      text-align: center;
    }

    .traj-row:hover .traj-inspect,
    .traj-row:focus .traj-inspect {
      opacity: 1;
    }

    /* Always show inspect icon on touch devices */
    @media (hover: none) {
      .traj-inspect {
        opacity: 0.6;
      }
    }

    /* Milestone dividers */
    .traj-milestone {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      margin: var(--space-1) 0;
    }

    .traj-milestone::before,
    .traj-milestone::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--color-border);
    }

    .traj-milestone-text {
      font-size: var(--font-size-2xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      white-space: nowrap;
    }

    /* Legend */
    .traj-legend {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-2);
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
    }

    .traj-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .traj-legend-swatch {
      width: var(--space-3);
      height: var(--space-2);
      border-radius: 2px;
    }

    .traj-legend-swatch.range { background: var(--color-bar-p75); }
    .traj-legend-swatch.p50 { background: var(--color-bar-p50); width: 3px; }

    .traj-hint {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-1);
      font-style: italic;
    }

    .traj-horizon-note {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-2);
      padding: var(--space-2);
      background: rgba(0, 0, 0, 0.03);
      border-radius: 4px;
      line-height: 1.4;
    }

    /* Screen reader only - visually hidden but accessible */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .copy-summary-wrap {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      margin-right: auto;
    }
    .copy-summary-btn {
      position: relative;
      width: 18px;
      height: 18px;
      padding: 0;
      font-size: 0;
      color: var(--color-text-tertiary);
      background: transparent;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: color 0.15s, background 0.15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      flex-shrink: 0;
    }
    .copy-summary-btn::before {
      content: '';
      width: 8px;
      height: 10px;
      border: 1.5px solid currentColor;
      border-radius: 1.5px;
      position: absolute;
      top: 2px;
      left: 2px;
    }
    .copy-summary-btn::after {
      content: '';
      width: 8px;
      height: 10px;
      border: 1.5px solid currentColor;
      border-radius: 1.5px;
      position: absolute;
      top: 5px;
      left: 5px;
      background: var(--color-background);
    }
    .copy-summary-btn:hover {
      background: var(--color-surface-hover);
      color: var(--color-text-secondary);
    }
    .copy-summary-btn:active {
      background: var(--color-surface-active);
    }
    .copy-summary-btn.copied {
      color: var(--color-success);
    }
    .copy-summary-btn.copied::before,
    .copy-summary-btn.copied::after {
      border-color: var(--color-success);
    }
    .copied-toast {
      font-size: var(--font-size-2xs);
      color: var(--color-success);
      opacity: 0;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .copied-toast.visible {
      opacity: 1;
    }

    /* Hide hint on touch devices (where it's redundant) */
    @media (hover: none) {
      .traj-hint {
        display: none;
      }
    }

    /* Constraint milestone marker */
    .traj-constraint-marker {
      font-size: var(--font-size-xs);
      color: var(--color-negative);
      padding: var(--space-2) 0;
      margin: var(--space-2) 0;
      border-top: 1px solid var(--color-bar-negative-border);
      border-bottom: 1px solid var(--color-bar-negative-border);
      background: var(--color-bar-negative);
    }

    .traj-constraint-note {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-2);
      padding: var(--space-2) 0;
    }

    /* Event marker on trajectory bar */
    .traj-event-marker {
      position: absolute;
      top: -3px;
      width: 6px;
      height: 6px;
      background: var(--color-link);
      border-radius: 50%;
      z-index: 3;
      transform: translateX(-3px);
      pointer-events: none;
    }

    /* Spending annotation */
    .traj-spending {
      font-size: var(--font-size-2xs);
      color: var(--color-text-muted);
      min-width: 48px;
      text-align: right;
    }

    .traj-scale-note {
      font-size: var(--font-size-2xs);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      padding: var(--space-1) var(--space-2);
      font-style: italic;
    }


    /* =========================================================================
     * YEAR INSPECTOR - Shows on click
     * ========================================================================= */
    .inspector {
      background: var(--color-surface-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-3) var(--space-4);
      margin-bottom: var(--space-4);
      display: none;
    }

    .inspector.visible {
      display: block;
    }

    .inspector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .inspector-title {
      font-size: var(--font-size-xs);
      font-weight: 500;
      color: var(--color-text);
    }

    .inspector-close {
      background: none;
      border: none;
      font-size: var(--font-size-md);
      color: var(--color-text-tertiary);
      cursor: pointer;
      /* 44px touch target */
      width: var(--control-2xl);
      height: var(--control-2xl);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: calc(-1 * var(--space-2));
      border-radius: var(--radius-sm);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .inspector-close:hover,
    .inspector-close:active {
      color: var(--color-text);
      background: var(--color-surface-elevated);
    }

    .inspector-close:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .ledger {
      font-family: inherit;
      font-size: var(--font-size-xs);
    }

    .ledger-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-1) 0;
      color: var(--color-text-secondary);
    }

    .ledger-row.total {
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-1);
      padding-top: var(--space-2);
      font-weight: 500;
      color: var(--color-text);
    }

    .ledger-row.positive { color: var(--color-positive); }
    .ledger-row.negative { color: var(--color-negative); }

    .ledger-section {
      margin: var(--space-2) 0;
    }

    .ledger-header {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      letter-spacing: 0.3px;
      padding-bottom: var(--space-1);
    }

    .ledger-indent {
      padding-left: var(--space-2);
    }

    .ledger-row.muted {
      color: var(--color-text-tertiary);
      font-style: italic;
    }

    .ledger-row span.positive {
      color: var(--color-positive);
    }

    .ledger-row span.negative {
      color: var(--color-negative);
    }


    /* =========================================================================
     * INSPECTOR SUMMARY HEADER - Quick-scan start→end with delta
     * ========================================================================= */
    .inspector-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      margin-bottom: var(--space-2);
      background: var(--color-surface-elevated);
      border-radius: var(--radius-md);
    }

    .inspector-summary-start,
    .inspector-summary-end {
      text-align: center;
      min-width: 60px;
    }

    .inspector-summary-label {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .inspector-summary-value {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text);
    }

    .inspector-summary-arrow {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      flex: 1;
      min-width: 50px;
    }

    .inspector-summary-delta {
      font-size: var(--font-size-xs);
      font-weight: 600;
    }

    .inspector-summary-delta.positive { color: var(--color-positive); }
    .inspector-summary-delta.negative { color: var(--color-negative); }

    .inspector-summary-line {
      display: flex;
      align-items: center;
      width: 100%;
      gap: 4px;
    }

    .inspector-summary-line::before,
    .inspector-summary-line::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--color-border);
    }

    .inspector-summary-line::after {
      background: linear-gradient(90deg, var(--color-border) 0%, transparent 100%);
    }

    .inspector-summary-line::before {
      background: linear-gradient(90deg, transparent 0%, var(--color-border) 100%);
    }

    .inspector-summary-chevron {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
    }

    /* =========================================================================
     * MINIMAL LEDGER - Clean ledger format (Layout B)
     * ========================================================================= */
    .minimal-ledger {
      background: var(--color-surface-elevated);
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-3);
      font-size: var(--font-size-xs);
    }

    .minimal-ledger-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      color: var(--color-text-secondary);
    }

    .minimal-ledger-row.indent {
      padding-left: var(--space-3);
    }

    .minimal-ledger-row.total {
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-1);
      padding-top: var(--space-2);
      font-weight: 500;
      color: var(--color-text);
    }

    .minimal-ledger-row .positive { color: var(--color-positive); }
    .minimal-ledger-row .negative { color: var(--color-negative); }

    .minimal-ledger-accounts {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      padding-top: var(--space-1);
      line-height: 1.4;
    }

    .minimal-ledger-accounts .val {
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    /* =========================================================================
     * STACKED ACCOUNTS BAR - Single bar showing allocation
     * ========================================================================= */
    .accounts-stack {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-subtle);
    }

    .accounts-stack-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .accounts-stack-bar {
      display: flex;
      height: 12px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--color-bar-bg);
    }

    .accounts-stack-segment {
      height: 100%;
      transition: width 0.2s ease;
    }

    .accounts-stack-segment.cash { background: var(--color-account-cash); }
    .accounts-stack-segment.taxable { background: var(--color-account-taxable); }
    .accounts-stack-segment.tax-deferred { background: var(--color-account-tax-deferred); }
    .accounts-stack-segment.roth { background: var(--color-account-roth); }

    .accounts-legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2) var(--space-3);
      margin-top: var(--space-2);
      font-size: var(--font-size-2xs);
    }

    /* =========================================================================
     * Onboarding (missing inputs)
     * ========================================================================= */
    .input-panel {
      background: var(--color-surface-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
    }

    .input-title {
      font-size: var(--font-size-md);
      font-weight: 600;
      margin-bottom: var(--space-1);
    }

    .input-subtitle {
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-3);
    }

    .input-form {
      display: grid;
      gap: var(--space-3);
    }

    .input-row {
      display: grid;
      gap: var(--space-1);
    }

    .input-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .input-control {
      height: var(--control-lg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 0 var(--space-3);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-sm);
    }

    .input-control:focus {
      outline: none;
      border-color: var(--color-link);
      box-shadow: var(--focus-ring);
    }

    .input-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-top: var(--space-2);
      flex-wrap: wrap;
    }

    .input-button {
      height: var(--control-lg);
      padding: 0 var(--space-4);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-text);
      color: var(--color-surface);
      font-weight: 600;
      cursor: pointer;
    }

    .input-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input-helper {
      font-size: var(--font-size-2xs);
      color: var(--color-text-muted);
    }

    .input-error {
      font-size: var(--font-size-xs);
      color: var(--color-negative);
      margin-top: var(--space-2);
    }

    .accounts-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-text-secondary);
    }

    .accounts-legend-swatch {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .accounts-legend-swatch.cash { background: var(--color-account-cash); }
    .accounts-legend-swatch.taxable { background: var(--color-account-taxable); }
    .accounts-legend-swatch.tax-deferred { background: var(--color-account-tax-deferred); }
    .accounts-legend-swatch.roth { background: var(--color-account-roth); }

    .accounts-legend-value {
      font-weight: 500;
      color: var(--color-text);
    }

    /* =========================================================================
     * INSPECTOR SUBSECTIONS - Withdrawals & Account Balances
     * ========================================================================= */
    .inspector-subsection {
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
    }

    .subsection-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .account-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) 0;
      font-size: var(--font-size-xs);
    }

    .account-label {
      min-width: 85px;
      color: var(--color-text-secondary);
    }

    .account-value {
      min-width: 55px;
      text-align: right;
      color: var(--color-text);
      font-weight: 500;
    }

    .account-bar-bg {
      flex: 1;
      height: var(--space-2);
      background: var(--color-bar-bg);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .account-bar {
      height: 100%;
      background: var(--color-bar-p50);
      border-radius: var(--radius-sm);
    }

    .account-pct {
      min-width: 32px;
      text-align: right;
      color: var(--color-text-tertiary);
      font-size: var(--font-size-2xs);
    }

    /* =========================================================================
     * ASSUMPTIONS - Collapsible
     * ========================================================================= */
    .assumptions-details {
      margin-bottom: var(--space-3);
    }

    .assumptions-details summary {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      cursor: pointer;
      list-style: none;
      padding: var(--space-2) 0;
    }

    .assumptions-details summary::-webkit-details-marker {
      display: none;
    }

    .assumptions-summary {
      display: inline;
    }

    .assumptions-summary span {
      display: inline;
    }

    .assumptions-summary span + span::before {
      content: " · ";
    }

    .assumptions-details summary::after {
      content: ' ▸';
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      margin-left: var(--space-1);
    }

    .assumptions-details[open] summary::after {
      content: ' ▾';
    }

    .assumptions-expanded {
      padding: var(--space-3);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      margin-top: var(--space-2);
    }

    .assumptions-section {
      margin-bottom: var(--space-3);
    }

    .assumptions-section:last-child {
      margin-bottom: 0;
    }

    .assumptions-section-title {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-1);
    }

    .assumptions-section-content {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .assumptions-section-content ul {
      margin: var(--space-1) 0 0 var(--space-4);
      padding: 0;
    }

    .assumptions-section-content li {
      margin-bottom: var(--space-1);
    }

    /* =========================================================================
     * FOOTER - Provenance
     * ========================================================================= */
    .footer {
      font-size: var(--font-size-2xs);
      color: var(--color-text-tertiary);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
      display: flex;
      gap: var(--space-2);
      align-items: center;
      white-space: nowrap;
      overflow: hidden;
    }

    .footer-advanced {
      display: inline;
      flex-shrink: 0;
    }

    .footer-advanced summary {
      cursor: pointer;
      list-style: none;
      display: inline;
      color: var(--color-link);
    }

    .footer-advanced summary::-webkit-details-marker {
      display: none;
    }

    .footer-advanced summary::after {
      content: ' ▸';
      font-size: 8px;
    }

    .footer-advanced[open] summary::after {
      content: ' ▾';
    }

    .footer-advanced-content {
      display: inline;
      margin-left: var(--space-1);
    }

    .footer-advanced-content span + span::before {
      content: " · ";
    }

    /* =========================================================================
     * COLLAPSIBLE SECTIONS (Progressive Enhancement)
     * ========================================================================= */
    details.collapsible {
      margin-bottom: var(--space-4);
    }

    details.collapsible summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      list-style: none;
      min-height: var(--control-2xl);
      padding: var(--space-2) 0;
      user-select: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    details.collapsible summary::-webkit-details-marker {
      display: none;
    }

    details.collapsible summary::after {
      content: '▸';
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      transition: transform 0.2s ease;
    }

    details.collapsible[open] summary::after {
      transform: rotate(90deg);
    }

    details.collapsible summary:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
      border-radius: var(--radius-sm);
    }

    @media (prefers-reduced-motion: reduce) {
      details.collapsible summary::after {
        transition: none;
      }
    }

    /* =========================================================================
     * LOADING / SKELETON STATES
     * ========================================================================= */
    .loading-state {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      padding: var(--space-4);
    }

    /* Loading vs Content toggle */
    .content-state { display: block; }
    .loading-state { display: none; }
    .widget.is-loading .content-state { display: none !important; }
    .widget.is-loading .loading-state { display: flex !important; }

    .skeleton {
      background: var(--color-surface-elevated);
      border-radius: var(--radius-md);
      animation: shimmer 1.5s ease-in-out infinite;
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: var(--space-2);
    }

    .skeleton-text.lg { height: 18px; width: 60%; }
    .skeleton-text.md { height: 14px; width: 80%; }
    .skeleton-text.sm { height: 12px; width: 40%; }

    .skeleton-bar {
      height: var(--space-4);
      margin-bottom: var(--space-2);
    }

    .skeleton-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-3);
    }

    .skeleton-grid-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    @keyframes shimmer {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    .loading-message {
      text-align: center;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      padding: var(--space-4);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-link);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: var(--space-2);
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* =========================================================================
     * LANDSCAPE MOBILE HANDLER
     * Handle edge case of landscape mobile orientation
     * ========================================================================= */
    @media (orientation: landscape) and (max-height: 500px) {
      .widget[data-display-mode="inline"] {
        max-width: 100%;
        padding: var(--space-3);
      }

      /* Reduce vertical spacing in landscape */
      .duration {
        padding: var(--space-2) var(--space-3);
        margin-bottom: var(--space-3);
      }

      .scenario {
        margin-bottom: var(--space-3);
      }

      .trajectory {
        margin-bottom: var(--space-3);
      }

      /* Smaller touch targets acceptable in landscape (more horizontal space) */
      .traj-row {
        min-height: 24px;
      }
    }

    /* Compact mode - add class="compact" to .widget for tighter spacing */
    .widget.compact .event {
      min-height: 22px;
      padding: 1px 0;
    }
    .widget.compact .traj-row {
      min-height: 20px;
      padding: 1px var(--space-2);
    }
    .widget.compact .duration {
      margin-bottom: var(--space-2);
      padding-bottom: var(--space-2);
    }
    .widget.compact .scenario {
      margin-bottom: var(--space-2);
    }
    .widget.compact .trajectory {
      margin-bottom: var(--space-2);
    }
    .widget.compact .traj-title {
      margin-bottom: var(--space-1);
    }
    .widget.compact .traj-legend {
      margin-top: var(--space-1);
      gap: var(--space-2);
    }

    /* Ultra-compact mode - maximum density */
    .widget.ultra-compact .event {
      min-height: 18px;
      padding: 0;
      gap: var(--space-1);
    }
    .widget.ultra-compact .traj-row {
      min-height: 16px;
      padding: 0 var(--space-1);
      gap: var(--space-1);
    }
    .widget.ultra-compact .traj-bar-container {
      height: 10px;
    }
    .widget.ultra-compact .duration {
      margin-bottom: var(--space-1);
      padding-bottom: var(--space-1);
      padding: var(--space-2);
    }
    .widget.ultra-compact .scenario {
      margin-bottom: var(--space-1);
      padding: var(--space-2);
    }
    .widget.ultra-compact .trajectory {
      margin-bottom: var(--space-1);
    }
    .widget.ultra-compact .traj-title {
      margin-bottom: 2px;
      font-size: var(--font-size-xs);
    }
    .widget.ultra-compact .traj-legend {
      margin-top: 2px;
      gap: var(--space-1);
    }
    .widget.ultra-compact .traj-age {
      width: 24px;
      font-size: 10px;
    }
    .widget.ultra-compact .traj-value {
      width: 48px;
      font-size: 10px;
    }
    .widget.ultra-compact .scenario-title,
    .widget.ultra-compact .duration-label {
      font-size: var(--font-size-xs);
    }
    .widget.ultra-compact .start-grid {
      gap: var(--space-1);
    }
    .widget.ultra-compact .events-list {
      gap: 0;
    }

    /* =========================================================================
     * EVENT DETAIL - "Show the math" collapsible section
     * ========================================================================= */
    .event-detail-toggle {
      margin-top: var(--space-3);
      border-top: 1px solid var(--color-border-subtle);
      padding-top: var(--space-2);
    }

    .event-detail-toggle summary {
      font-size: var(--font-size-xs);
      color: var(--color-link);
      cursor: pointer;
      list-style: none;
      padding: var(--space-2) 0;
      user-select: none;
    }

    .event-detail-toggle summary::-webkit-details-marker {
      display: none;
    }

    .event-detail-toggle summary::before {
      content: '▸ ';
      font-size: var(--font-size-2xs);
    }

    .event-detail-toggle[open] summary::before {
      content: '▾ ';
    }

    .event-detail-content {
      padding-top: var(--space-2);
    }

    .event-detail-month {
      font-size: var(--font-size-2xs);
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-2);
    }

    .event-card {
      background: var(--color-surface-elevated);
      border-left: 3px solid var(--color-link);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      padding: var(--space-2) var(--space-3);
      margin-bottom: var(--space-2);
      font-size: var(--font-size-xs);
    }

    .event-card:last-child {
      margin-bottom: 0;
    }

    .event-card-name {
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-1);
    }

    .event-card-flow {
      display: flex;
      justify-content: space-between;
      color: var(--color-text-secondary);
    }

    .event-card-delta {
      font-weight: 500;
    }

    .event-card-delta.positive {
      color: var(--color-positive);
    }

    .event-card-delta.negative {
      color: var(--color-negative);
    }

    .event-detail-empty {
      font-size: var(--font-size-xs);
      color: var(--color-text-tertiary);
      font-style: italic;
      padding: var(--space-2) 0;
    }

    /* =========================================================================
     * MONTHLY TRACE - Compact month-by-month event timeline
     * ========================================================================= */
    .monthly-trace {
      font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.5;
    }

    .monthly-trace-month {
      margin-bottom: var(--space-2);
    }

    .monthly-trace-month-header {
      font-weight: 600;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10px;
      padding: var(--space-1) 0;
      border-bottom: 1px solid var(--color-border-subtle);
      margin-bottom: 2px;
    }

    .monthly-trace-event {
      display: flex;
      justify-content: space-between;
      padding: 1px 0;
      gap: var(--space-2);
    }

    .monthly-trace-name {
      color: var(--color-text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }

    .monthly-trace-delta {
      font-weight: 500;
      white-space: nowrap;
      text-align: right;
      min-width: 70px;
    }

    .monthly-trace-delta.positive {
      color: var(--color-positive);
    }

    .monthly-trace-delta.negative {
      color: var(--color-negative);
    }

    .monthly-trace-balance {
      color: var(--color-text-muted);
      white-space: nowrap;
      text-align: right;
      min-width: 70px;
    }

  </style>
</head>
<body>
  <div class="widget is-loading" id="root">
    <!-- Loading State -->
    <div class="loading-state">
      <div class="header">
        <span class="header-brand">Chubby</span>
        <span class="header-tag">Educational simulation</span>
      </div>
      <div class="loading-message" aria-live="polite">
        <span class="loading-spinner"></span>
        Running simulation...
      </div>
      <div class="skeleton skeleton-text lg"></div>
      <div class="skeleton skeleton-text md"></div>
      <div class="skeleton-grid">
        <div class="skeleton-grid-item">
          <div class="skeleton skeleton-text sm"></div>
          <div class="skeleton skeleton-text md"></div>
        </div>
        <div class="skeleton-grid-item">
          <div class="skeleton skeleton-text sm"></div>
          <div class="skeleton skeleton-text md"></div>
        </div>
        <div class="skeleton-grid-item">
          <div class="skeleton skeleton-text sm"></div>
          <div class="skeleton skeleton-text md"></div>
        </div>
        <div class="skeleton-grid-item">
          <div class="skeleton skeleton-text sm"></div>
          <div class="skeleton skeleton-text md"></div>
        </div>
      </div>
      <div class="skeleton skeleton-bar" style="width: 90%"></div>
      <div class="skeleton skeleton-bar" style="width: 75%"></div>
      <div class="skeleton skeleton-bar" style="width: 85%"></div>
      <div class="skeleton skeleton-bar" style="width: 60%"></div>
    </div>

    <!-- Content State -->
    <div class="content-state">
    <!-- Header -->
    <div class="header">
      <span class="header-brand">Chubby</span>
      <span class="header-tag">Educational simulation</span>
    </div>

    <!-- Plan Duration -->
    <div class="duration" id="duration-section">
      <div class="duration-label">Plan Duration</div>
      <div class="duration-question">How long does this plan work?</div>
      <div class="duration-answer" id="duration-answer">
        <!-- Populated by JS: either outcome list or saturated message -->
      </div>
      <div class="duration-note" id="duration-note"></div>
    </div>

    <!-- Scenario -->
    <div class="scenario" id="scenario-section">
      <div class="scenario-section">
        <div class="scenario-title">Starting Point</div>
        <div class="start-grid" id="start-grid">
          <div>
            <div class="start-item-label">Age</div>
            <div class="start-item-value" id="start-age">50</div>
          </div>
          <div>
            <div class="start-item-label" title="Total investable assets (excludes home equity)">Assets</div>
            <div class="start-item-value" id="start-assets">$1.2M</div>
          </div>
          <div>
            <div class="start-item-label" title="Annual gross income before taxes">Income</div>
            <div class="start-item-value" id="start-income">$180K</div>
          </div>
          <div>
            <div class="start-item-label" title="Annual spending (inflates with modeled inflation)">Spending</div>
            <div class="start-item-value" id="start-spending">$80K</div>
          </div>
        </div>
      </div>
      <div class="scenario-section" id="events-section" style="display: none;">
        <div class="scenario-title">Scheduled Events</div>
        <div class="events" id="events"></div>
      </div>
    </div>

    <!-- Trajectory -->
    <div class="trajectory" id="trajectory-section">
      <div class="traj-title">Simulated Outcomes Over Time</div>
      <div class="traj-explanation" id="traj-explanation" style="display: none; font-size: var(--font-size-xs); color: var(--color-text-tertiary); margin-bottom: var(--space-2);"></div>
      <div id="trajectory-bars"></div>
      <div class="traj-legend">
        <div class="traj-legend-item" title="10th to 75th percentile: the range from pessimistic (P10) to optimistic (P75)"><span class="traj-legend-swatch range"></span> Pessimistic (P10) → Optimistic (P75)</div>
        <div class="traj-legend-item" title="50th percentile (median): half of simulated scenarios end above this value, half below"><span class="traj-legend-swatch p50"></span> Typical (P50)</div>
      </div>
      <div class="traj-legend-note" style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2);" title="Each age shows percentiles across all simulated paths at that point. This is not one continuous 'typical path' over time — each age is an independent cross-section of outcomes.">Percentiles recalculated at each age</div>
      <div class="traj-hint">Tap an age to see the math</div>
      <div style="font-size: var(--font-size-2xs); color: var(--color-text-muted); margin-top: var(--space-1);">Nominal (future) dollars · Year-end values</div>
      <div id="traj-horizon-note" class="traj-horizon-note" style="display: none;"></div>
    </div>

    <!-- Survival - Hidden by default (redundant with Plan Duration header) -->
    <!-- <div class="survival" id="survival-section" style="display: none;">
      <div class="survival-title">Futures Still Funded</div>
      <div class="survival-anchor" style="font-size: var(--font-size-xs); color: var(--color-text-tertiary); margin-bottom: var(--space-2);">
        % of simulated futures where assets remain above $0 at each age.
        Funded means baseline spending is sustained without depleting investment assets.
      </div>
      <div id="survival-bars"></div>
    </div> -->

    <!-- Year Inspector -->
    <div class="inspector" id="inspector" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="inspector-title">
      <div class="inspector-header">
        <span class="inspector-title" id="inspector-title">Year 2035 (Age 60)</span>
        <button class="inspector-close" id="inspector-close" aria-label="Close inspector" type="button">×</button>
      </div>
      <div class="ledger" id="ledger"></div>
      <div id="withdrawals-section"></div>
      <div id="accounts-section"></div>
    </div>

    <!-- Assumptions (collapsible) -->
    <details class="collapsible assumptions-details" id="assumptions-details">
      <summary>
        <span class="assumptions-summary" id="assumptions-summary">
          <span>Stocks 7% / Bonds 3%</span>
          <span>Surplus auto-invested</span>
          <span>~2.5% inflation</span>
          <span>Taxes: not modeled</span>
        </span>
      </summary>
      <div class="assumptions-expanded" id="assumptions-expanded">
        <div class="assumptions-section">
          <div class="assumptions-section-title">Returns Model (nominal)</div>
          <div class="assumptions-section-content">
            <ul>
              <li>Equities: ~7% mean annual return, ~18% volatility</li>
              <li>Bonds: ~4% mean annual return, ~6% volatility</li>
            </ul>
            <div style="font-size: var(--font-size-2xs); color: var(--color-text-muted); margin-top: var(--space-2);">
              Higher volatility means a wider spread between "Harder" and "Optimistic" outcomes over time.
            </div>
            <div style="font-size: var(--font-size-2xs); color: var(--color-text-muted); margin-top: var(--space-1); font-style: italic;">
              These are long-run illustrative assumptions — not a prediction of future performance.
            </div>
          </div>
        </div>
        <div class="assumptions-section">
          <div class="assumptions-section-title">Investment Behavior</div>
          <div class="assumptions-section-content">
            <ul>
              <li>Income surplus is deposited as cash</li>
              <li>Cash above ~6 months of expenses is auto-invested into portfolio (per asset allocation)</li>
              <li>Portfolio rebalanced quarterly when drift exceeds 5%</li>
            </ul>
          </div>
        </div>
        <div class="assumptions-section">
          <div class="assumptions-section-title">Inflation</div>
          <div class="assumptions-section-content">
            ~2.5% annual inflation applied to spending. All dollar values shown are nominal (not adjusted for inflation).
          </div>
        </div>
        <div class="assumptions-section">
          <div class="assumptions-section-title">Withdrawal Order</div>
          <div class="assumptions-section-content">
            Taxable → Tax-deferred → Roth (standard sequence)
          </div>
        </div>
      </div>
    </details>

    <!-- Footer -->
    <div class="footer" id="footer">
      <span class="copy-summary-wrap">
        <button id="copy-summary-btn" class="copy-summary-btn" title="Copy summary" aria-label="Copy summary"><span class="sr-only">Copy summary</span></button>
        <span id="copied-toast" class="copied-toast">Copied!</span>
      </span>
      <span>Age <span id="horizon-age">—</span></span>
      <span>·</span>
      <details class="footer-advanced">
        <summary><span id="paths-run">100</span> paths</summary>
        <div class="footer-advanced-content">
          <span>Seed: <span id="seed">—</span></span>
        </div>
      </details>
      <span id="viewer-link-sep" style="display:none;">·</span>
      <a id="viewer-link" href="#" target="_blank" rel="noopener" style="display:none; color: var(--color-link); text-decoration: none;">Share ↗</a>
    </div>
    </div><!-- end content-state -->
  </div>

  <script>
    // =========================================================================
    // Theme
    // =========================================================================

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme || 'light');
      // Don't set colorScheme on html - keep it 'normal' to avoid UA canvas painting
      // color-scheme is set on body via CSS, which inherits to the widget subtree
      console.log('[Chubby Widget] Theme:', theme);
    }

    function detectTheme() {
      if (window.openai?.theme) {
        applyTheme(window.openai.theme);
        return;
      }
      if (window.matchMedia) {
        const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(dark ? 'dark' : 'light');
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (!window.openai?.theme) applyTheme(e.matches ? 'dark' : 'light');
        });
      }
    }

    detectTheme();

    window.addEventListener('message', e => {
      if (e.data?.type === 'themeChange') applyTheme(e.data.theme);
    });

    window.addEventListener('openai:set_globals', e => {
      if (e.detail?.globals?.theme) applyTheme(e.detail.globals.theme);
    }, { passive: true });

    // =========================================================================
    // Display Mode Detection (OpenAI Apps SDK)
    // =========================================================================

    function applyDisplayMode(mode) {
      const widget = document.getElementById('root');
      if (!widget) return;
      const validModes = ['inline', 'pip', 'fullscreen'];
      const m = validModes.includes(mode) ? mode : 'inline';
      widget.setAttribute('data-display-mode', m);
      console.log('[Chubby Widget] Display mode:', m);
    }

    function detectDisplayMode() {
      // OpenAI Apps SDK provides displayMode
      if (window.openai?.displayMode) {
        applyDisplayMode(window.openai.displayMode);
        return;
      }
      // Default to inline for chat context
      applyDisplayMode('inline');
    }

    detectDisplayMode();

    window.addEventListener('openai:set_globals', e => {
      if (e.detail?.globals?.displayMode) applyDisplayMode(e.detail.globals.displayMode);
    }, { passive: true });

    window.addEventListener('message', e => {
      if (e.data?.type === 'displayModeChange') applyDisplayMode(e.data.mode);
    });

    // =========================================================================
    // Max Height Support (OpenAI Apps SDK)
    // Prevents internal scrolling by respecting host container constraints
    // =========================================================================

    function applyMaxHeight(maxHeight) {
      const widget = document.getElementById('root');
      if (!widget || !maxHeight || maxHeight <= 0) return;
      // Apply max-height to prevent internal scrolling (per OpenAI guidelines)
      widget.style.maxHeight = maxHeight + 'px';
      widget.style.overflowY = 'auto';
      console.log('[Chubby Widget] Max height:', maxHeight);
    }

    function detectMaxHeight() {
      if (window.openai?.maxHeight) {
        applyMaxHeight(window.openai.maxHeight);
      }
    }

    detectMaxHeight();

    window.addEventListener('openai:set_globals', e => {
      if (e.detail?.globals?.maxHeight) applyMaxHeight(e.detail.globals.maxHeight);
    }, { passive: true });

    window.addEventListener('message', e => {
      if (e.data?.type === 'maxHeightChange') applyMaxHeight(e.data.maxHeight);
    });

    // =========================================================================
    // Format Utilities
    // =========================================================================

    function fmt(v) {
      if (v == null) return '—';
      // Handle negative values with proper K/M suffix
      const sign = v < 0 ? '-' : '';
      const abs = Math.abs(v);
      if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
      if (abs >= 1e3) return sign + '$' + Math.round(abs / 1e3) + 'K';
      return sign + '$' + Math.round(abs);
    }

    var fmtYr = fmt;

    function fmtSigned(v) {
      if (v == null) return '—';
      const sign = v >= 0 ? '+' : '−';
      const abs = Math.abs(v);
      if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(1) + 'M';
      if (abs >= 1e3) return sign + '$' + Math.round(abs / 1e3) + 'K';
      return sign + '$' + Math.round(abs);
    }

    // =========================================================================
    // State
    // =========================================================================

    let data = null;
    let durationConstraintAge = null; // Set by renderDuration, used by renderTrajectory for consistency
    let durationConstraintPct = null; // Depleted %, single source of truth for header + trajectory marker

    // =========================================================================
    // Render: Duration
    // =========================================================================

    function getMedianEndingAssets(d) {
      // Try mc.finalNetWorthP50
      if (d.mc?.finalNetWorthP50 != null) return d.mc.finalNetWorthP50;

      // Try last trajectory point
      const trajectory = d.netWorthTrajectory || d.mc?.netWorthTrajectory || [];
      if (trajectory.length > 0) {
        const last = trajectory[trajectory.length - 1];
        return last.p50 || 0;
      }

      // Try last annual snapshot
      const snaps = d.annualSnapshots || [];
      if (snaps.length > 0) {
        const last = snaps[snaps.length - 1];
        return last.endBalance || 0;
      }

      return 0;
    }

    function getP10EndingAssets(d) {
      // Try mc.finalNetWorthP10
      if (d.mc?.finalNetWorthP10 != null) return d.mc.finalNetWorthP10;

      // Try last trajectory point
      const trajectory = d.netWorthTrajectory || d.mc?.netWorthTrajectory || [];
      if (trajectory.length > 0) {
        const last = trajectory[trajectory.length - 1];
        // Use P10 if available, otherwise estimate from P50
        return last.p10 || (last.p50 * 0.55) || 0;
      }

      return 0;
    }

    // Find the first age where a constraint marker would fire (pctPathsFunded < 50%)
    // Returns { age, pctDepleted } or null if no constraint fires
    function getFirstConstraintAge(d) {
      const trajectory = d.netWorthTrajectory || d.mc?.netWorthTrajectory || [];
      const currentAge = d.inputs?.currentAge || 35;

      for (const pt of trajectory) {
        const pctPathsFunded = pt.pctPathsFunded ?? pt.survivalRate;
        const p50 = pt.p50 || 0;

        // Same logic as renderTrajectory: constraint fires when funded < 50% or p50 <= 0
        const isConstrained = pctPathsFunded !== undefined
          ? pctPathsFunded < 0.5
          : p50 <= 0;

        if (isConstrained) {
          const monthOffset = pt.monthOffset || pt.month || 0;
          const age = currentAge + Math.floor(monthOffset / 12);
          const pctDepleted = pctPathsFunded !== undefined
            ? Math.round((1 - pctPathsFunded) * 100)
            : null;
          return { age, pctDepleted };
        }
      }

      return null;
    }

    function renderDuration(d) {
      const pd = d.planDuration;
      const horizonMonths = d.inputs?.horizonMonths || 360;
      const currentAge = d.inputs?.currentAge || 35;
      const horizonAge = currentAge + Math.floor(horizonMonths / 12);

      let mostAge, earlierAge, laterAge, saturated;

      if (pd) {
        mostAge = pd.mostPathsAge;
        earlierAge = pd.earlierStressAge;
        laterAge = pd.laterOutcomesAge;
        saturated = pd.horizonSaturated;
      } else {
        // Support both new names (runwayP*Months) and deprecated names (runwayP*) for backward compatibility
        const runwayP10 = d.mc?.runwayP10Months ?? d.mc?.runwayP10 ?? horizonMonths;
        const runwayP50 = d.mc?.runwayP50Months ?? d.mc?.runwayP50 ?? horizonMonths;
        const runwayP75 = d.mc?.runwayP75Months ?? d.mc?.runwayP75 ?? d.mc?.runwayP90 ?? horizonMonths;
        mostAge = currentAge + Math.floor(runwayP50 / 12);
        earlierAge = currentAge + Math.floor(runwayP10 / 12);
        laterAge = currentAge + Math.floor(runwayP75 / 12);
        saturated = runwayP50 >= horizonMonths;
      }

      // Additional saturation detection:
      // If spending constraint probability is very low (<5%), effectively saturated
      const lowConstraintProb = (d.mc?.everBreachProbability ?? 1) < 0.05;

      if (!saturated && lowConstraintProb) {
        saturated = true;
        console.log('[Chubby Widget] Detected effective saturation:',
          { lowConstraintProb, mostAge, earlierAge, laterAge });
      }

      // Get DOM elements for mode switching
      const durationSection = document.getElementById('duration-section');
      const labelEl = durationSection.querySelector('.duration-label');
      const questionEl = durationSection.querySelector('.duration-question');
      const answerEl = document.getElementById('duration-answer');
      const noteEl = document.getElementById('duration-note');

      // Get ending assets to check if "saturated" is meaningful
      const p50Assets = getMedianEndingAssets(d);
      const annualSpending = d.inputs?.annualSpending || 0;

      // Check if a constraint marker will appear in the trajectory
      // This prevents saying "stays funded" when trajectory shows a constraint warning
      const firstConstraint = getFirstConstraintAge(d);

      // If technically saturated but ending with near-zero assets, show constrained view instead
      // "Near-zero" = less than 1 year of spending or less than $10k
      const nearZeroThreshold = Math.max(annualSpending, 10000);

      // NOT effectively saturated if:
      // 1. P50 assets at end are near-zero, OR
      // 2. A constraint marker will fire in the trajectory
      const effectivelySaturated = saturated && p50Assets > nearZeroThreshold && !firstConstraint;

      // Store constraint age + pct for renderTrajectory to use (single source of truth)
      if (firstConstraint) {
        durationConstraintAge = firstConstraint.age;
        durationConstraintPct = firstConstraint.pctDepleted;
      } else if (!effectivelySaturated && !saturated) {
        durationConstraintAge = mostAge;
        durationConstraintPct = null;
      } else {
        durationConstraintAge = null;
        durationConstraintPct = null;
      }

      if (effectivelySaturated) {
        // MODE: Plan Duration (saturated case)
        // Different header and framing when plan never runs out
        labelEl.textContent = 'Plan Duration';
        questionEl.style.display = 'none'; // No question needed - statement mode

        // Calculate spending multiplier (pure arithmetic, not advice)
        const spendingMultiple = annualSpending > 0 ? Math.round(p50Assets / annualSpending) : null;
        const multiplierLine = spendingMultiple ?
          '<div class="duration-multiplier">Ending assets / current annual spending: ' + spendingMultiple + '</div>' : '';

        answerEl.innerHTML =
          '<div class="duration-saturated">' +
            '<div class="duration-saturated-headline" title="Assets remain positive across all simulated paths through the end of the simulation window.">Assets remain above $0 through Age ' + horizonAge + ' (simulation horizon)</div>' +
            '<div class="duration-saturated-details">(end of simulation)</div>' +
            '<div class="duration-saturated-assets">' +
              '<span title="Half of simulated outcomes are better, half are worse">Typical assets at that age: <strong>~' + fmt(p50Assets) + '</strong></span>' +
              multiplierLine +
            '</div>' +
            '<div class="duration-horizon-note">' +
              'The simulation stops at Age ' + horizonAge + '. Outcomes beyond are not modeled.' +
            '</div>' +
          '</div>';
        noteEl.style.display = 'none';
      } else if (saturated && firstConstraint) {
        // MODE: Constraint within saturated horizon
        // P50 runway reaches horizon, but a significant portion of paths hit constraint earlier
        labelEl.textContent = 'Plan Duration';
        questionEl.style.display = 'none';

        const constraintNote = firstConstraint.pctDepleted
          ? 'In ' + firstConstraint.pctDepleted + '% of scenarios, assets are depleted by Age ' + firstConstraint.age + '.'
          : 'In most scenarios, assets are depleted by Age ' + firstConstraint.age + '.';

        answerEl.innerHTML =
          '<div class="duration-saturated">' +
            '<div class="duration-saturated-headline" title="Funded means baseline spending is sustained without depleting investment assets. Median path reaches horizon, but many paths deplete earlier.">Plan reaches Age ' + horizonAge + ' in favorable scenarios</div>' +
            '<div class="duration-saturated-details" style="color: var(--color-warning, #d97706);" title="Depleted means investment assets have been exhausted and baseline spending can no longer be sustained.">' + constraintNote + '</div>' +
            '<div class="duration-saturated-assets">' +
              '<span title="Half of simulated outcomes are better, half are worse">Typical ending assets: <strong>~' + fmt(p50Assets) + '</strong></span>' +
            '</div>' +
          '</div>';
        noteEl.style.display = 'none';
      } else if (saturated && p50Assets <= nearZeroThreshold) {
        // MODE: Marginal Coverage (technically saturated but ending near $0)
        // Show a more nuanced message
        labelEl.textContent = 'Plan Duration';
        questionEl.style.display = 'none';

        answerEl.innerHTML =
          '<div class="duration-saturated">' +
            '<div class="duration-saturated-headline" title="Funded means baseline spending is sustained without depleting investment assets. Assets last through the simulation but are nearly depleted.">This plan reaches Age ' + horizonAge + ' with minimal reserves</div>' +
            '<div class="duration-saturated-details">(end of simulation)</div>' +
            '<div class="duration-saturated-assets">' +
              '<span title="Half of simulated outcomes are better, half are worse">Typical assets at that age: <strong>~' + fmt(p50Assets) + '</strong></span>' +
            '</div>' +
            '<div class="duration-horizon-note" style="color: var(--color-warning, #d97706);">' +
              'Assets are nearly exhausted by horizon. Consider reducing spending or extending income.' +
            '</div>' +
          '</div>';
        noteEl.style.display = 'none';
      } else {
        // MODE: Plan Duration (constrained case)
        // Show the question for constrained scenarios
        labelEl.textContent = 'Plan Duration';
        questionEl.style.display = 'block';
        questionEl.textContent = 'When does this plan run out?';

        // Build causal explanation based on available data
        let causalNote = '';
        if (d.incomeChange && d.incomeChange.newAnnualIncome === 0) {
          const incomeStopAge = currentAge + Math.floor(d.incomeChange.monthOffset / 12);
          causalNote = '<div class="duration-cause">Why: Spending exceeds portfolio returns after income stops at Age ' + incomeStopAge + '.</div>';
        } else if (d.inputs?.expectedIncome === 0) {
          causalNote = '<div class="duration-cause">Why: No income — spending draws down assets.</div>';
        }

        answerEl.innerHTML =
          '<div class="duration-constrained">' +
            '<div class="duration-saturated-headline">This plan runs out around:</div>' +
            '<ul class="duration-outcomes">' +
              '<li class="typical" title="Half of simulated outcomes last longer, half run out sooner"><span class="age">Age ' + mostAge + '</span> in a typical outcome</li>' +
              '<li title="In 10% of simulated paths, assets are depleted by this age"><span class="age">Age ' + earlierAge + '</span> in harder scenarios</li>' +
            '</ul>' +
            '<div class="duration-note" title="Funded means baseline spending is sustained without depleting investment assets.">After this, baseline spending would become unsustainable.</div>' +
            causalNote +
          '</div>';
        noteEl.style.display = 'none';
      }
    }

    // =========================================================================
    // Render: Scenario
    // =========================================================================

    function renderScenario(d) {
      const sch = d.schedule;
      const inp = d.inputs;

      // Starting point
      if (sch?.startingPoint) {
        document.getElementById('start-age').textContent = sch.startingPoint.age;
        document.getElementById('start-assets').textContent = fmt(sch.startingPoint.assets);
        document.getElementById('start-income').textContent = fmtYr(sch.startingPoint.income);
        document.getElementById('start-spending').textContent = fmtYr(sch.startingPoint.spending);
      } else if (inp) {
        document.getElementById('start-age').textContent = inp.currentAge;
        document.getElementById('start-assets').textContent = fmt(inp.investableAssets);
        document.getElementById('start-income').textContent = fmtYr(inp.expectedIncome);
        document.getElementById('start-spending').textContent = fmtYr(inp.annualSpending);
      }

      // Events - always show section, with explicit message when empty
      const eventsEl = document.getElementById('events');
      const eventsSection = document.getElementById('events-section');
      const horizonMonths = d.inputs?.horizonMonths || 360;
      const horizonAge = (d.inputs?.currentAge || 35) + Math.floor(horizonMonths / 12);

      // Filter events to only show those within simulation horizon (defense in depth)
      let events = (sch?.scheduledEvents || buildEvents(d))
        .filter(e => e.age <= horizonAge);

      eventsSection.style.display = 'block';
      if (events.length > 0) {
        eventsEl.innerHTML = events.map(e =>
          '<div class="event">' +
            '<span class="event-icon">' + (e.icon || '📅') + '</span>' +
            '<span class="event-age">Age ' + e.age + '</span>' +
            '<span class="event-label">' + e.label + '</span>' +
            '<span class="event-change">' + e.change + '</span>' +
          '</div>'
        ).join('');
      } else {
        eventsEl.innerHTML =
          '<div class="events-empty">' +
            'No future changes scheduled.<br>' +
            '<span class="events-empty-note">(Income and spending assumed constant)</span>' +
          '</div>';
      }
    }

    function buildEvents(d) {
      const events = [];
      const age = d.inputs?.currentAge || 35;
      const m2a = m => age + Math.floor(m / 12);

      if (d.incomeChange) {
        const ic = d.incomeChange;
        events.push({
          age: m2a(ic.monthOffset),
          icon: '📅',
          label: ic.description || (ic.newAnnualIncome === 0 ? 'Retirement' : 'Income change'),
          change: ic.newAnnualIncome === 0 ? '$0' : fmtYr(ic.newAnnualIncome)
        });
      }
      if (d.spendingChange) {
        const sc = d.spendingChange;
        events.push({
          age: m2a(sc.monthOffset),
          icon: '📅',
          label: sc.description || 'Spending change',
          change: fmtYr(sc.newAnnualSpending)
        });
      }
      if (d.socialSecurity) {
        events.push({
          age: d.socialSecurity.claimingAge,
          icon: '🏛️',
          label: 'Social Security',
          change: '+' + fmtYr(d.socialSecurity.monthlyBenefit * 12)
        });
      }
      if (d.rothConversions) {
        d.rothConversions.forEach(rc => {
          events.push({
            age: age + rc.yearOffset,
            icon: '🔄',
            label: 'Roth conversion',
            change: fmt(rc.amount)
          });
        });
      }
      if (d.oneTimeEvents) {
        d.oneTimeEvents.forEach(ote => {
          events.push({
            age: m2a(ote.monthOffset),
            icon: ote.type === 'income' ? '💰' : '💸',
            label: ote.description,
            change: fmt(ote.amount)
          });
        });
      }
      return events.sort((a, b) => a.age - b.age);
    }

    // =========================================================================
    // Render: Trajectory with P10→P75 bar + P50 marker
    // =========================================================================

    function renderTrajectory(d) {
      const currentAge = d.inputs?.currentAge || 35;
      const horizonMonths = d.inputs?.horizonMonths || 360;
      const endAge = currentAge + Math.floor(horizonMonths / 12);
      const trajectory = d.netWorthTrajectory || d.mc?.netWorthTrajectory || [];
      const explanationEl = document.getElementById('traj-explanation');

      // If no trajectory data, show placeholder message
      if (trajectory.length === 0) {
        document.getElementById('trajectory-bars').innerHTML =
          '<div style="padding: var(--space-4); text-align: center; color: var(--color-text-muted); font-size: var(--font-size-sm);">' +
          'Trajectory data not available. Run with more MC paths.' +
          '</div>';
        explanationEl.style.display = 'none';
        return;
      }

      // Detect phase and provide driver-aware explanation
      const firstPoint = trajectory[0];
      const lastPoint = trajectory[trajectory.length - 1];
      const startAssets = firstPoint?.p50 || d.inputs?.investableAssets || 0;
      const endAssets = lastPoint?.p50 || 0;
      const annualSpending = d.inputs?.annualSpending || 0;
      const annualIncome = d.inputs?.expectedIncome || d.inputs?.annualIncome || 0;

      // Determine phase: accumulation (saving) vs decumulation (spending down)
      const isAccumulating = annualIncome > annualSpending;
      const assetsGrow = endAssets > startAssets;

      // Show phase-appropriate explanation
      if (assetsGrow && annualSpending > 0) {
        if (isAccumulating) {
          explanationEl.textContent = 'This scenario is in accumulation: modeled income exceeds spending, so assets rise from ongoing contributions. Market returns add uncertainty.';
        } else {
          explanationEl.textContent = 'Assets grow because expected investment returns exceed withdrawals.';
        }
        explanationEl.style.display = 'block';
      } else if (!assetsGrow && annualSpending > annualIncome) {
        explanationEl.textContent = 'This scenario is in decumulation: spending exceeds modeled income, so withdrawals fund the gap. Market returns drive how quickly assets change.';
        explanationEl.style.display = 'block';
      } else {
        explanationEl.style.display = 'none';
      }

      const milestones = buildMilestones(d, currentAge);

      // Build event marker map: age → event description (for dot markers on bars)
      const eventMarkers = {};
      const schedEvents = d.schedule?.scheduledEvents || buildEvents(d);
      for (const e of schedEvents) {
        eventMarkers[e.age] = e.label || e.change || 'Event';
      }

      // Sample ages - use 10yr intervals for long horizons (>50yr) to keep ≤7 rows
      const horizonYears = endAge - currentAge;
      const interval = horizonYears > 50 ? 10 : 5;

      const ages = new Set();
      // Start from first round interval after currentAge
      const firstAge = Math.ceil(currentAge / interval) * interval;
      for (let a = firstAge; a <= endAge; a += interval) ages.add(a);
      // Always include start and end
      ages.add(currentAge);
      ages.add(endAge);
      // Include milestone ages
      Object.keys(milestones).forEach(a => ages.add(parseInt(a)));

      const sortedAges = [...ages].sort((a, b) => a - b);

      // Find max for scaling - use P75 since the bar now spans P10→P75
      let maxP75 = 0;
      let firstConstraintAge = null; // Age when median first hits 0
      trajectory.forEach(pt => {
        const p75 = (pt.p75 != null ? pt.p75 : (pt.p50 || 0) * 1.5) || 0;
        if (p75 > maxP75) maxP75 = p75;
        // Detect first constraint (when P50 goes to 0 or below)
        const p50 = pt.p50 || 0;
        if (firstConstraintAge === null && p50 <= 0) {
          const monthOffset = pt.monthOffset || pt.month || 0;
          firstConstraintAge = currentAge + Math.floor(monthOffset / 12);
        }
      });
      // Scale to P75 max + 10% padding
      const maxVal = maxP75 > 0 ? maxP75 * 1.1 : 1;

      let html = '';
      let lastMilestone = null;
      let constraintMarkerShown = false;

      sortedAges.forEach(age => {
        const yearOffset = age - currentAge;
        const monthOffset = yearOffset * 12;

        // Find closest point (WASM uses monthOffset, not month)
        let pt = trajectory[0] || { p10: 0, p50: 0, p75: 0 };
        let minDiff = Math.abs((trajectory[0]?.monthOffset || trajectory[0]?.month || 0) - monthOffset);
        trajectory.forEach(p => {
          const diff = Math.abs((p.monthOffset || p.month || 0) - monthOffset);
          if (diff < minDiff) { minDiff = diff; pt = p; }
        });

        // Milestone divider
        if (milestones[age] && milestones[age] !== lastMilestone) {
          html += '<div class="traj-milestone"><span class="traj-milestone-text">' + milestones[age] + '</span></div>';
          lastMilestone = milestones[age];
        }

        // Floor values at 0 (Option A: no negative display)
        const p10Raw = (pt.p10 != null ? pt.p10 : pt.p50 * 0.7) || 0;
        const p50Raw = pt.p50 || 0;
        const p75Raw = (pt.p75 != null ? pt.p75 : pt.p50 * 1.5) || 0;

        const p10 = Math.max(0, p10Raw);
        const p50 = Math.max(0, p50Raw);
        const p75 = Math.max(0, p75Raw);

        // Pct paths funded: % of paths still funded at this age
        // Support both new name (pctPathsFunded) and deprecated name (survivalRate) for backward compatibility
        const pctPathsFunded = pt.pctPathsFunded ?? pt.survivalRate;

        // Detect constraint: use pctPathsFunded if available, else fall back to P50 check
        // Constraint = funded < 50% (most paths have hit constraint)
        const isConstrained = pctPathsFunded !== undefined
          ? pctPathsFunded < 0.5
          : p50Raw <= 0;

        // Once constraint is hit, show marker and continue with P75 until it also depletes
        if (isConstrained) {
          if (!constraintMarkerShown) {
            // Use durationConstraintAge + durationConstraintPct (from renderDuration)
            // as single source of truth to avoid % mismatch between header and trajectory
            const markerAge = durationConstraintAge || age;
            const depletedPct = durationConstraintPct;
            const depletedText = depletedPct !== null
              ? 'In ' + depletedPct + '% of scenarios, assets depleted by Age ' + markerAge
              : 'In most scenarios, assets depleted by Age ' + markerAge;
            html += '<div class="traj-constraint-marker">' + depletedText + '</div>';
            constraintMarkerShown = true;
          }
          // Stop when even P75 hits 0 — all paths depleted
          if (p75 <= 0) return;
          // Otherwise fall through to render normal bar — P10/P50 at 0, P75 still visible
        }

        // Scale to percentage
        const pct10 = Math.round((p10 / maxVal) * 100);
        const pct50 = Math.min(100, Math.round((p50 / maxVal) * 100));
        const pct75 = Math.min(100, Math.round((p75 / maxVal) * 100));

        const rowClass = 'traj-row';

        // Tooltip shows all three scenarios
        const tooltipText = 'Age ' + age + ': Harder ' + fmt(p10) + ' · Typical ' + fmt(p50) + ' · Optimistic ' + fmt(p75);
        const ariaLabel = 'Age ' + age + ', median net worth ' + fmt(p50) + '. Press Enter or tap to view details.';

        // Show P10→P75 range bar with P50 marker inside
        const rangeWidth = p75 > p10 ? Math.max(1, pct75 - pct10) : 0;
        const showRange = true;

        // Event marker dot (if this age has a scheduled event)
        let eventMarkerHtml = '';
        if (eventMarkers[age]) {
          eventMarkerHtml = '<div class="traj-event-marker" style="left:' + pct50 + '%" title="' + eventMarkers[age] + '"></div>';
        }

        // Spending annotation (if spending data available on trajectory point)
        let spendingHtml = '';
        const spendingP50 = pt.spendingP50;
        if (spendingP50 != null && spendingP50 > 0) {
          spendingHtml = '<span class="traj-spending" aria-hidden="true" title="Typical annual spending at this age">' + fmtYr(spendingP50) + '/yr</span>';
        }

        // Tooltip - include spending if available
        let fullTooltip = tooltipText;
        if (spendingP50 != null && spendingP50 > 0) {
          fullTooltip += ' · Spending ~' + fmtYr(spendingP50) + '/yr';
        }
        if (eventMarkers[age]) {
          fullTooltip += ' · Event: ' + eventMarkers[age];
        }

        html += '<div class="' + rowClass + '" data-age="' + age + '" data-year="' + yearOffset + '" ' +
          'role="button" tabindex="0" aria-label="' + ariaLabel + '" title="' + fullTooltip + '">' +
          '<span class="traj-age" aria-hidden="true">' + age + '</span>' +
          '<div class="traj-bar-container" aria-hidden="true">' +
            (showRange ? '<div class="traj-bar-range" style="left:' + pct10 + '%; width:' + rangeWidth + '%"></div>' : '') +
            '<div class="traj-bar-p50" style="left:' + pct50 + '%"></div>' +
            eventMarkerHtml +
          '</div>' +
          '<span class="traj-value" aria-hidden="true">' + fmt(p50) + (constraintMarkerShown && pctPathsFunded !== undefined ? ' (' + Math.round((1 - pctPathsFunded) * 100) + '% depleted)' : '') + '</span>' +
          spendingHtml +
          '<span class="traj-inspect" aria-hidden="true" title="Tap to inspect">ⓘ</span>' +
        '</div>';
      });

      // Add explanatory note if assets depleted
      if (constraintMarkerShown) {
        html += '<div class="traj-constraint-note">' +
          'After depletion, remaining funded paths rely on fixed income (e.g., Social Security). ' +
          'No spending reduction is modeled.' +
        '</div>';
      }

      document.getElementById('trajectory-bars').innerHTML = html;

      // Click and keyboard handlers for trajectory rows
      document.querySelectorAll('.traj-row').forEach(row => {
        const handler = () => {
          showInspector(parseInt(row.dataset.age), parseInt(row.dataset.year));
        };
        row.addEventListener('click', handler);
        row.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handler();
          }
        });
      });

      // Show late-horizon uncertainty note if trajectory extends to age 70+
      const horizonNote = document.getElementById('traj-horizon-note');
      if (endAge >= 70) {
        horizonNote.style.display = 'block';
        horizonNote.textContent = 'Note: Uncertainty naturally widens over long horizons. The spread between outcomes at age ' +
          endAge + ' reflects compounding variability, not model error.';
      } else {
        horizonNote.style.display = 'none';
      }
    }

    function buildMilestones(d, age) {
      const ms = {};
      const m2a = m => age + Math.floor(m / 12);

      // Primary: read from schedule.scheduledEvents (present in lean payload)
      const events = d.schedule?.scheduledEvents;
      if (events && events.length > 0) {
        for (const e of events) {
          if (e.type === 'income' && e.change === '$0') {
            ms[e.age] = e.label || 'Retirement';
          } else if (e.type === 'social_security') {
            ms[e.age] = 'Social Security';
          }
        }
      } else {
        // Fallback: legacy payload fields
        if (d.incomeChange?.newAnnualIncome === 0) {
          ms[m2a(d.incomeChange.monthOffset)] = d.incomeChange.description || 'Retirement';
        }
        if (d.socialSecurity) {
          ms[d.socialSecurity.claimingAge] = 'Social Security';
        }
      }
      return ms;
    }

    // =========================================================================
    // Render: Survival
    // =========================================================================

    function renderSurvival(d, currentAge, endAge) {
      const breachData = d.mc?.breachProbabilityByMonth;
      const section = document.getElementById('survival-section');

      if (!breachData || breachData.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';

      const decades = [];
      const first = Math.ceil(currentAge / 10) * 10;
      for (let a = first; a <= endAge; a += 10) {
        if (a > currentAge) decades.push(a);
      }

      let html = '';
      decades.forEach(age => {
        const years = age - currentAge;
        const idx = Math.min(years * 12 - 1, breachData.length - 1);
        const pct = Math.round((1 - (breachData[idx]?.cumulativeBreachProb || 0)) * 100);

        html += '<div class="survival-row">' +
          '<span class="survival-age">Age ' + age + '</span>' +
          '<div class="survival-bar-bg"><div class="survival-bar" style="width:' + pct + '%"></div></div>' +
          '<span class="survival-pct">' + pct + '%</span>' +
        '</div>';
      });

      document.getElementById('survival-bars').innerHTML = html;
    }

    // =========================================================================
    // Year Inspector
    // =========================================================================

    // Helper: render a sub-item in the ledger
    function subItem(prefix, label, value, muted) {
      const cls = muted ? 'ledger-row ledger-indent muted' : 'ledger-row ledger-indent';
      const valStr = muted ? '—' : fmt(value);
      return '<div class="' + cls + '"><span>' + prefix + ' ' + label + '</span><span>' + valStr + '</span></div>';
    }

    // Helper: render account bar
    function accountBar(label, value, total) {
      const pct = total > 0 ? Math.round((value / total) * 100) : 0;
      return '<div class="account-row">' +
        '<span class="account-label">' + label + '</span>' +
        '<span class="account-value">' + fmt(value) + '</span>' +
        '<div class="account-bar-bg"><div class="account-bar" style="width:' + pct + '%"></div></div>' +
        '<span class="account-pct">' + pct + '%</span>' +
      '</div>';
    }

    // Build income breakdown from snapshot
    function renderIncomeBreakdown(snap, totalIncome) {
      let html = '';
      const src = snap.cashFlow?.incomeSources || {};

      // Check if we have detailed breakdown
      const hasDetails = src.employment > 0 || src.socialSecurity > 0 || src.investment > 0;

      if (hasDetails) {
        if (src.employment > 0) html += subItem('├─', 'Salary', src.employment);
        if (src.socialSecurity > 0) html += subItem('├─', 'Social Security', src.socialSecurity);
        if (src.investment > 0) html += subItem('├─', 'Investment income', src.investment);
        // Replace last ├─ with └─
        html = html.replace(/├─([^├]+)$/, '└─$1');
      } else if (totalIncome > 0) {
        // Fallback: show aggregate
        html = subItem('└─', 'Earnings & benefits', totalIncome);
      } else {
        html = subItem('└─', '(none this year)', 0, true);
      }
      return html;
    }

    // Build spending breakdown from snapshot
    function renderSpendingBreakdown(snap, totalExpenses) {
      let html = '';
      const exp = snap.cashFlow?.expenseSources || {};

      // Check if we have detailed breakdown
      const living = exp.living || 0;
      const healthcare = exp.healthcare || 0;
      const hasDetails = living > 0 || healthcare > 0;

      if (hasDetails) {
        if (living > 0) html += subItem('├─', 'Living expenses', living);
        if (healthcare > 0) html += subItem('├─', 'Healthcare', healthcare);
        // Replace last ├─ with └─
        html = html.replace(/├─([^├]+)$/, '└─$1');
      } else {
        // Fallback: show aggregate
        html = subItem('└─', 'Living expenses', totalExpenses);
      }
      return html;
    }

    // Build tax breakdown from snapshot
    function renderTaxBreakdown(snap) {
      const t = snap.cashFlow?.expenseSources?.taxes || {};
      if (!t.total && !t.federal && !t.state && !t.capitalGains) return '';

      let html = '';
      if (t.federal > 0) html += subItem('├─', 'Federal', t.federal);
      if (t.state > 0) html += subItem('├─', 'State', t.state);
      if (t.capitalGains > 0) html += subItem('├─', 'Capital gains', t.capitalGains);
      if (t.fica > 0) html += subItem('├─', 'FICA', t.fica);
      // Replace last ├─ with └─
      html = html.replace(/├─([^├]+)$/, '└─$1');
      return html;
    }

    // Render withdrawals section
    function renderWithdrawals(snap) {
      const w = snap.withdrawals || snap.withdrawalsByAccount || {};
      const taxable = w.taxable || w.taxableBrokerage || 0;
      const taxDeferred = w.taxDeferred || w.account401k || w.ira || 0;
      const roth = w.roth || w.rothIRA || 0;
      const total = taxable + taxDeferred + roth;

      if (total === 0) return '';

      return '<div class="inspector-subsection">' +
        '<div class="subsection-title">Withdrawals (funding spending)</div>' +
        accountBar('From Taxable', taxable, total) +
        accountBar('From Tax-deferred', taxDeferred, total) +
        accountBar('From Roth', roth, total) +
      '</div>';
    }

    // Render account balances section (legacy - keeping for fallback)
    function renderAccountBalances(snap) {
      const accts = snap.balanceSheet?.investmentAccounts || snap.accounts || {};
      const cash = accts.cash || 0;
      const taxable = accts.taxableBrokerage || accts.taxable || 0;
      const taxDeferred = accts.account401k || accts.taxDeferred || accts.ira || 0;
      const roth = accts.rothIRA || accts.roth || 0;
      const total = snap.endBalance || (cash + taxable + taxDeferred + roth) || 1;

      // Only show if we have account-level data
      if (!accts.cash && !accts.taxableBrokerage && !accts.taxable && !accts.account401k && !accts.taxDeferred && !accts.rothIRA && !accts.roth) {
        return '';
      }

      return '<div class="inspector-subsection">' +
        '<div class="subsection-title">Accounts (year-end)</div>' +
        accountBar('Cash', cash, total) +
        accountBar('Taxable', taxable, total) +
        accountBar('Tax-deferred', taxDeferred, total) +
        accountBar('Roth', roth, total) +
      '</div>';
    }

    // Render stacked accounts bar (new visual)
    function renderStackedAccounts(snap) {
      const accts = snap.balanceSheet?.investmentAccounts || snap.accounts || {};
      const cash = accts.cash || 0;
      const taxable = accts.taxableBrokerage || accts.taxable || 0;
      const taxDeferred = accts.account401k || accts.taxDeferred || accts.ira || 0;
      const roth = accts.rothIRA || accts.roth || 0;
      const total = cash + taxable + taxDeferred + roth;

      // Only show if we have account-level data
      if (total === 0) return '';

      const pctCash = Math.round((cash / total) * 100);
      const pctTaxable = Math.round((taxable / total) * 100);
      const pctTaxDeferred = Math.round((taxDeferred / total) * 100);
      const pctRoth = 100 - pctCash - pctTaxable - pctTaxDeferred; // remainder to avoid rounding issues

      let segments = '';
      if (pctCash > 0) segments += '<div class="accounts-stack-segment cash" style="width:' + pctCash + '%"></div>';
      if (pctTaxable > 0) segments += '<div class="accounts-stack-segment taxable" style="width:' + pctTaxable + '%"></div>';
      if (pctTaxDeferred > 0) segments += '<div class="accounts-stack-segment tax-deferred" style="width:' + pctTaxDeferred + '%"></div>';
      if (pctRoth > 0) segments += '<div class="accounts-stack-segment roth" style="width:' + pctRoth + '%"></div>';

      let legend = '';
      if (cash > 0) legend += '<div class="accounts-legend-item"><span class="accounts-legend-swatch cash"></span>Cash <span class="accounts-legend-value">' + fmt(cash) + '</span></div>';
      if (taxable > 0) legend += '<div class="accounts-legend-item"><span class="accounts-legend-swatch taxable"></span>Taxable <span class="accounts-legend-value">' + fmt(taxable) + '</span></div>';
      if (taxDeferred > 0) legend += '<div class="accounts-legend-item"><span class="accounts-legend-swatch tax-deferred"></span>Tax-def <span class="accounts-legend-value">' + fmt(taxDeferred) + '</span></div>';
      if (roth > 0) legend += '<div class="accounts-legend-item"><span class="accounts-legend-swatch roth"></span>Roth <span class="accounts-legend-value">' + fmt(roth) + '</span></div>';

      return '<div class="accounts-stack">' +
        '<div class="accounts-stack-title">Account Allocation (Year-End)</div>' +
        '<div class="accounts-stack-bar">' + segments + '</div>' +
        '<div class="accounts-legend">' + legend + '</div>' +
      '</div>';
    }

    // Render summary header (start → delta → end)
    function renderInspectorSummary(start, end) {
      const delta = end - start;
      const deltaClass = delta >= 0 ? 'positive' : 'negative';

      return '<div class="inspector-summary">' +
        '<div class="inspector-summary-start">' +
          '<div class="inspector-summary-label">Start</div>' +
          '<div class="inspector-summary-value">' + fmt(start) + '</div>' +
        '</div>' +
        '<div class="inspector-summary-arrow">' +
          '<div class="inspector-summary-delta ' + deltaClass + '">' + fmtSigned(delta) + '</div>' +
          '<div class="inspector-summary-line"><span class="inspector-summary-chevron">→</span></div>' +
        '</div>' +
        '<div class="inspector-summary-end">' +
          '<div class="inspector-summary-label">End</div>' +
          '<div class="inspector-summary-value">' + fmt(end) + '</div>' +
        '</div>' +
      '</div>';
    }

    // Build minimal ledger (Layout B style)
    function renderMinimalLedger(snap) {
      const start = snap.startBalance || 0;
      const end = snap.endBalance || 0;
      const income = snap.totalIncome ?? 0;
      const expenses = snap.totalExpenses ?? 0;
      const growth = snap.investmentGrowth ?? (end - start - income + expenses);
      const pct = snap.returnPct ? (Math.abs(snap.returnPct) > 1 ? snap.returnPct : snap.returnPct * 100) : 0;

      // Rich data from full payload (if available)
      const cf = snap.cashFlow || {};
      const src = cf.incomeSources || {};
      const exp = cf.expenseSources || {};
      const hasCashFlow = Object.keys(cf).length > 0;

      // Taxes
      const taxes = exp.taxes?.total || 0;

      // Divestment proceeds (sold from portfolio to fund spending gap)
      const divestment = src.divestmentProceeds || snap.divestmentProceeds || 0;

      // Contributions (deposits into investment accounts)
      const contributions = cf.savingsAnalysis?.totalContributions || snap.contributions || 0;

      // Build income line items
      let incomeLines = [];
      if (hasCashFlow) {
        const employment = src.employment?.total ?? 0;
        const ss = src.retirement?.socialSecurity ?? 0;
        const pension = src.retirement?.pension ?? 0;
        const invest = src.investment?.total ?? 0;
        if (employment > 0) incomeLines.push({ label: 'Salary', value: employment });
        if (ss > 0) incomeLines.push({ label: 'Social Security', value: ss });
        if (pension > 0) incomeLines.push({ label: 'Pension', value: pension });
        if (invest > 0) incomeLines.push({ label: 'Investment income', value: invest });
      } else if (income > 0) {
        incomeLines.push({ label: 'Income', value: income });
      }

      // Build expense line items
      let expenseLines = [];
      if (hasCashFlow) {
        const livingTotal = exp.living?.total ?? 0;
        const healthcare = exp.living?.healthcare ?? 0;
        const otherLiving = livingTotal - healthcare;
        if (otherLiving > 0) expenseLines.push({ label: 'Living expenses', value: otherLiving });
        if (healthcare > 0) expenseLines.push({ label: 'Healthcare', value: healthcare });
      } else if (expenses > 0) {
        expenseLines.push({ label: 'Living expenses', value: expenses });
      }

      // Account balances from balanceSheet (rich) or accountBalances (legacy)
      const bs = snap.balanceSheet || {};
      const accts = bs.investmentAccounts || snap.accountBalances || {};
      const cashBal = bs.cash || accts.cash || 0;
      const taxable = accts.taxableBrokerage || accts.taxable || 0;
      const taxDeferred = accts.account401k || accts.taxDeferred || accts['tax-deferred'] || 0;
      const roth = accts.rothIRA || accts.roth || 0;

      // Build HTML
      let html = '<div class="minimal-ledger">';

      // Start
      html += '<div class="minimal-ledger-row"><span>Start</span><span>' + fmtFull(start) + '</span></div>';

      // Income items
      for (const item of incomeLines) {
        html += '<div class="minimal-ledger-row indent"><span>+ ' + item.label + '</span><span class="positive">+' + fmtFull(item.value) + '</span></div>';
      }

      // Expense items
      for (const item of expenseLines) {
        html += '<div class="minimal-ledger-row indent"><span>− ' + item.label + '</span><span class="negative">−' + fmtFull(item.value) + '</span></div>';
      }

      // Taxes
      if (taxes > 0) {
        html += '<div class="minimal-ledger-row indent"><span>− Taxes</span><span class="negative">−' + fmtFull(taxes) + '</span></div>';
      }

      // Portfolio flows: sold from portfolio / deposited into accounts
      if (divestment > 0) {
        html += '<div class="minimal-ledger-row indent"><span>− Sold from portfolio</span><span class="negative">−' + fmtFull(divestment) + '</span></div>';
      }
      if (contributions > 0) {
        html += '<div class="minimal-ledger-row indent"><span>+ Invested into accounts</span><span class="positive">+' + fmtFull(contributions) + '</span></div>';
      }

      // Market return
      const marketSign = growth >= 0 ? '+' : '';
      const marketClass = growth >= 0 ? 'positive' : 'negative';
      html += '<div class="minimal-ledger-row indent"><span>± Market (' + (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%)</span><span class="' + marketClass + '">' + marketSign + fmtFull(growth) + '</span></div>';

      // End (total row)
      html += '<div class="minimal-ledger-row total"><span>End</span><span>' + fmtFull(end) + '</span></div>';

      // Account breakdown under End (from balanceSheet)
      let accountParts = [];
      if (cashBal > 0) accountParts.push('Cash <span class="val">' + fmt(cashBal) + '</span>');
      if (taxable > 0) accountParts.push('Taxable <span class="val">' + fmt(taxable) + '</span>');
      if (taxDeferred > 0) accountParts.push('Tax-def <span class="val">' + fmt(taxDeferred) + '</span>');
      if (roth > 0) accountParts.push('Roth <span class="val">' + fmt(roth) + '</span>');
      if (accountParts.length > 0) {
        html += '<div class="minimal-ledger-accounts">' + accountParts.join(' · ') + '</div>';
      }

      html += '</div>';
      return html;
    }

    // Format full number (not abbreviated)
    function fmtFull(n) {
      if (n == null || isNaN(n)) return '$0';
      // Handle negative values properly
      const sign = n < 0 ? '-' : '';
      const abs = Math.abs(Math.round(n));
      return sign + '$' + abs.toLocaleString('en-US');
    }

    // Render first-month events for "show the math" (compact monospace layout)
    function renderShowTheMath(age, year) {
      const events = data.firstMonthEvents?.[age];
      if (!events || events.length === 0) return null;

      let html = '<div class="monthly-trace">';
      html += '<div class="monthly-trace-month">';
      html += '<div class="monthly-trace-month-header">January ' + year + '</div>';

      for (const evt of events) {
        const delta = evt.d || 0;
        const deltaClass = delta >= 0 ? 'positive' : 'negative';
        const deltaSign = delta >= 0 ? '+' : '\u2212';
        const deltaAbs = Math.abs(delta);
        html += '<div class="monthly-trace-event">' +
          '<span class="monthly-trace-name">' + (evt.n || 'Event') + '</span>' +
          '<span class="monthly-trace-delta ' + deltaClass + '">' + deltaSign + '$' + deltaAbs.toLocaleString('en-US') + '</span>' +
          '<span class="monthly-trace-balance">$' + Math.max(0, evt.ca).toLocaleString('en-US') + '</span>' +
        '</div>';
      }

      html += '</div></div>';
      return html;
    }

    function showInspector(age, yearOffset) {
      if (!data) return;

      const inspector = document.getElementById('inspector');
      const year = (data.startYear || 2024) + yearOffset;

      document.getElementById('inspector-title').innerHTML = 'Age ' + age + ' — Outcome range';

      const ledger = document.getElementById('ledger');
      const withdrawalsSection = document.getElementById('withdrawals-section');
      const accountsSection = document.getElementById('accounts-section');

      // Always look up trajectory P50/P10 for the headline
      const trajectory = data.netWorthTrajectory || data.mc?.netWorthTrajectory || [];
      const currentAge = data.inputs?.currentAge || 35;
      const monthOffset = (age - currentAge) * 12;
      let pt = null;
      let minDiff = Infinity;
      trajectory.forEach(p => {
        const diff = Math.abs((p.monthOffset || p.month || 0) - monthOffset);
        if (diff < minDiff) { minDiff = diff; pt = p; }
      });

      const p10 = Math.max(0, pt ? (pt.p10 != null ? pt.p10 : 0) : 0);
      const p50 = Math.max(0, pt ? (pt.p50 || 0) : 0);
      const p75 = Math.max(0, pt ? (pt.p75 != null ? pt.p75 : 0) : 0);
      const isConstrained = pt ? (pt.p50 || 0) <= 0 : false;

      // Primary: P50/P10 headline (matches trajectory bar)
      let ledgerHtml = '<div class="minimal-ledger">' +
        '<div class="minimal-ledger-row" style="font-weight: 500; color: var(--color-text-tertiary); font-size: var(--font-size-2xs); text-transform: uppercase; letter-spacing: 0.3px; padding-bottom: var(--space-2);">Net Worth at Age ' + age + '</div>' +
        '<div class="minimal-ledger-row total"><span>Typical (P50)</span><span>' + (isConstrained ? '$0 ⚠️' : fmt(p50)) + '</span></div>' +
        '<div class="minimal-ledger-row"><span>Harder scenarios (P10)</span><span>' + fmt(p10) + '</span></div>';
      if (p75 > 0 && !isConstrained) {
        ledgerHtml += '<div class="minimal-ledger-row"><span>Stronger markets (P75)</span><span>' + fmt(p75) + '</span></div>';
      }
      if (isConstrained) {
        ledgerHtml += '<div style="margin-top: var(--space-2); padding: var(--space-2); background: rgba(217, 115, 13, 0.1); border-radius: 4px; font-size: var(--font-size-2xs); color: #d9730d;">Assets depleted — spending exceeded available resources.</div>';
      }
      ledgerHtml += '</div>';

      // Secondary: exemplar path details (one example path)
      const snaps = data.annualSnapshots || [];
      const snap = snaps.find(s => s.age === age) || snaps.find(s => Math.abs(s.age - age) <= 1);

      if (snap) {
        ledgerHtml += '<details class="event-detail-toggle" style="margin-top: var(--space-3);">' +
          '<summary>One random example path — not the median</summary>' +
          '<div class="event-detail-content">' +
            renderMinimalLedger(snap) +
          '</div>' +
        '</details>';
        accountsSection.innerHTML = renderStackedAccounts(snap);
      } else {
        accountsSection.innerHTML = '';
      }

      ledger.innerHTML = ledgerHtml;

      // Show the math (month-by-month event replay)
      const mathHtml = renderShowTheMath(age, year);
      if (mathHtml) {
        withdrawalsSection.innerHTML = '<details class="event-detail-toggle">' +
          '<summary>Show the math</summary>' +
          '<div class="event-detail-content">' + mathHtml + '</div>' +
        '</details>';
      } else {
        withdrawalsSection.innerHTML = '';
      }

      inspector.classList.add('visible');
      inspector.setAttribute('aria-hidden', 'false');

      // Track triggering element for focus return
      inspector._triggerEl = document.activeElement;

      // Scroll inspector into view, then focus close button
      inspector.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      const closeBtn = document.getElementById('inspector-close');
      if (closeBtn) closeBtn.focus();
    }

    function renderNeedsInput(payload) {
      const root = document.getElementById('root');
      if (!root) return;

      const stateDraft = window.openai?.widgetState?.inputDraft || {};
      const inputDraft = { ...(payload?.inputDraft || {}), ...stateDraft };
      const missingFields = payload?.missingFields || [];
      const labelMap = {
        investableAssets: 'investable assets',
        annualSpending: 'annual spending',
        currentAge: 'current age',
        expectedIncome: 'annual income (0 if retired)',
      };
      const missingText = missingFields.map((field) => labelMap[field] || field).join(', ');

      root.classList.remove('is-loading');
      root.innerHTML = `
        <div class="header">
          <span class="header-brand">Chubby</span>
        </div>
        <div class="input-panel">
          <div class="input-title">Run a simulation</div>
          <div class="input-subtitle">Add the missing basics and I’ll run the model.</div>
          ${missingText ? `<div class="input-helper">Missing: ${missingText}</div>` : ''}
          <form id="inputForm" class="input-form">
            <div class="input-row">
              <label class="input-label" for="input-investableAssets">Investable assets (USD)</label>
              <input id="input-investableAssets" class="input-control" type="number" inputmode="decimal" step="any" min="0" placeholder="500000" value="${inputDraft.investableAssets ?? ''}">
            </div>
            <div class="input-row">
              <label class="input-label" for="input-annualSpending">Annual spending (USD)</label>
              <input id="input-annualSpending" class="input-control" type="number" inputmode="decimal" step="any" min="0" placeholder="60000" value="${inputDraft.annualSpending ?? ''}">
              <div class="input-helper">Inflates automatically with modeled inflation (~2.5%/yr).</div>
            </div>
            <div class="input-row">
              <label class="input-label" for="input-currentAge">Current age</label>
              <input id="input-currentAge" class="input-control" type="number" inputmode="numeric" step="1" min="0" placeholder="35" value="${inputDraft.currentAge ?? ''}">
            </div>
            <div class="input-row">
              <label class="input-label" for="input-expectedIncome">Annual gross income (USD)</label>
              <input id="input-expectedIncome" class="input-control" type="number" inputmode="decimal" step="any" min="0" placeholder="120000" value="${inputDraft.expectedIncome ?? ''}">
              <div class="input-helper">Before taxes. Use 0 if retired.</div>
            </div>
            <div class="input-actions">
              <button id="inputSubmit" class="input-button" type="submit">Run simulation</button>
              <div class="input-helper">Seed and start year are set automatically.</div>
            </div>
            <div id="inputError" class="input-error" style="display:none;"></div>
          </form>
        </div>
      `;

      const form = document.getElementById('inputForm');
      const errorEl = document.getElementById('inputError');
      const submitBtn = document.getElementById('inputSubmit');
      const inputIds = ['investableAssets', 'annualSpending', 'currentAge', 'expectedIncome'];

      inputIds.forEach((field) => {
        const el = document.getElementById(`input-${field}`);
        if (!el) return;
        el.addEventListener('input', () => {
          const nextDraft = {};
          inputIds.forEach((key) => {
            const fieldEl = document.getElementById(`input-${key}`);
            if (fieldEl) nextDraft[key] = fieldEl.value;
          });
          if (window.openai?.setWidgetState) {
            window.openai.setWidgetState({ inputDraft: nextDraft });
          }
        });
      });

      if (form) {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!window.openai?.callTool) {
            if (errorEl) {
              errorEl.textContent = 'Tool calls are unavailable in this environment.';
              errorEl.style.display = 'block';
            }
            return;
          }

          const parseValue = (field) => {
            const el = document.getElementById(`input-${field}`);
            if (!el || el.value === '') return undefined;
            const value = Number(el.value);
            return Number.isNaN(value) ? undefined : value;
          };

          const args = {
            investableAssets: parseValue('investableAssets'),
            annualSpending: parseValue('annualSpending'),
            currentAge: parseValue('currentAge'),
            expectedIncome: parseValue('expectedIncome'),
            seed: payload?.seed ?? Date.now(),
            startYear: payload?.startYear ?? new Date().getFullYear(),
          };

          const missing = [];
          if (!(args.investableAssets > 0)) missing.push('investable assets');
          if (!(args.annualSpending > 0)) missing.push('annual spending');
          if (!(args.currentAge > 0)) missing.push('current age');
          if (!(args.expectedIncome >= 0)) missing.push('annual income');

          if (missing.length > 0) {
            if (errorEl) {
              errorEl.textContent = `Please provide: ${missing.join(', ')}.`;
              errorEl.style.display = 'block';
            }
            return;
          }

          if (errorEl) {
            errorEl.style.display = 'none';
          }
          if (submitBtn) {
            submitBtn.textContent = 'Running...';
            submitBtn.setAttribute('disabled', 'true');
          }

          try {
            await window.openai.callTool('run_simulation_packet', args);
          } catch (err) {
            if (errorEl) {
              errorEl.textContent = 'Simulation failed to start. Please try again.';
              errorEl.style.display = 'block';
            }
            if (submitBtn) {
              submitBtn.textContent = 'Run simulation';
              submitBtn.removeAttribute('disabled');
            }
          }
        });
      }
    }

    // =========================================================================
    // Render: Assumptions (dynamic)
    // =========================================================================

    function renderAssumptions(d) {
      // Tax mode
      const tax = d.taxMode === 'NOT_APPLIED' ? 'Taxes: not modeled' :
                  d.taxMode === 'SIMPLIFIED' ? 'Taxes: applied (simplified)' :
                  d.taxMode === 'USER_DECLARED' ? 'User tax rates' :
                  d.taxMode ? 'Taxes: ' + d.taxMode : 'Taxes: not modeled';

      // Return assumptions — always resolved by server, never null
      const ra = d.returnAssumptions || {};
      const stockPctLabel = Math.round((ra.stockReturn ?? 0.07) * 100);
      const bondPctLabel = Math.round((ra.bondReturn ?? 0.03) * 100);
      const inflPct = (ra.inflationRate ?? 0.025) * 100;
      let allocLabel = 'Stocks ' + stockPctLabel + '% / Bonds ' + bondPctLabel + '%';
      const inflLabel = '~' + inflPct.toFixed(1) + '% inflation';

      // Summary line
      document.getElementById('assumptions-summary').innerHTML =
        '<span>' + allocLabel + '</span><span>Surplus auto-invested</span><span>' + inflLabel + '</span><span>' + tax + '</span>';

      // Expanded section - update returns model
      const expandedEl = document.getElementById('assumptions-expanded');
      if (expandedEl) {
        let expandedHtml = '<div class="assumptions-section">' +
          '<div class="assumptions-section-title">Returns Model (nominal)</div>' +
          '<div class="assumptions-section-content">' +
            '<ul>' +
              '<li>Equities: ~' + stockPctLabel + '% mean annual return, ~18% volatility</li>' +
              '<li>Bonds: ~' + bondPctLabel + '% mean annual return, ~6% volatility</li>' +
              '<li>Inflation: ~' + inflPct.toFixed(1) + '%</li>' +
            '</ul>';
        expandedHtml += '<div style="font-size: var(--font-size-2xs); color: var(--color-text-muted); margin-top: var(--space-2);">' +
            'Higher volatility means a wider spread between "Harder" and "Optimistic" outcomes over time.' +
          '</div>' +
          '<div style="font-size: var(--font-size-2xs); color: var(--color-text-muted); margin-top: var(--space-1); font-style: italic;">' +
            'These are long-run illustrative assumptions — not a prediction of future performance.' +
          '</div>' +
          '</div></div>';

        // Investment behavior
        var cashReserveDesc = '~6 months of expenses';
        if (d.cashReserve) {
          if (d.cashReserve.targetAmount) {
            cashReserveDesc = '$' + fmt(d.cashReserve.targetAmount);
          } else if (d.cashReserve.targetMonths) {
            cashReserveDesc = '~' + d.cashReserve.targetMonths + ' months of expenses';
          }
        }
        var rebalDesc = 'quarterly when drift exceeds 5%';
        if (d.rebalancing) {
          if (d.rebalancing.method === 'none') {
            rebalDesc = 'none (no rebalancing)';
          } else {
            var freq = d.rebalancing.frequency || 'quarterly';
            var thresh = d.rebalancing.thresholdPct != null
              ? Math.round(d.rebalancing.thresholdPct * 100) + '%'
              : '5%';
            if (d.rebalancing.method === 'periodic') {
              rebalDesc = freq;
            } else {
              rebalDesc = freq + ' when drift exceeds ' + thresh;
            }
          }
        }
        expandedHtml += '<div class="assumptions-section">' +
          '<div class="assumptions-section-title">Investment Behavior</div>' +
          '<div class="assumptions-section-content">' +
            '<ul>' +
              '<li>Income surplus is deposited as cash</li>' +
              '<li>Cash above ' + cashReserveDesc + ' is auto-invested into portfolio (per asset allocation)</li>' +
              '<li>Portfolio rebalanced ' + rebalDesc + '</li>' +
            '</ul>' +
          '</div>' +
        '</div>';

        expandedHtml += '<div class="assumptions-section">' +
          '<div class="assumptions-section-title">Inflation</div>' +
          '<div class="assumptions-section-content">' + inflLabel + ' applied to spending</div>' +
        '</div>';

        expandedHtml += '<div class="assumptions-section">' +
          '<div class="assumptions-section-title">Tax Treatment</div>' +
          '<div class="assumptions-section-content">' + tax + '</div>' +
        '</div>';

        // Withdrawal order
        var withdrawalDesc = 'Cash → Taxable → Tax-deferred → Roth (tax-efficient)';
        if (d.withdrawalStrategy === 'pro_rata') {
          withdrawalDesc = 'Proportional from all accounts (pro rata)';
        } else if (d.withdrawalStrategy === 'roth_first') {
          withdrawalDesc = 'Roth → Taxable → Tax-deferred → Cash (Roth first)';
        }
        expandedHtml += '<div class="assumptions-section">' +
          '<div class="assumptions-section-title">Withdrawal Order</div>' +
          '<div class="assumptions-section-content">' +
            withdrawalDesc +
          '</div>' +
        '</div>';

        expandedEl.innerHTML = expandedHtml;
      }
    }

    // =========================================================================
    // Init
    // =========================================================================

    function init(raw) {
      if (!raw) return;
      // Priority: _meta.widgetData (optimized) > structuredContent (legacy) > result > raw
      // The optimized path puts full data in _meta.widgetData to reduce model context
      data = raw._meta?.widgetData || raw.structuredContent || raw.result || raw;
      const source = raw._meta?.widgetData ? '_meta.widgetData (optimized)' :
                     raw.structuredContent ? 'structuredContent (legacy)' :
                     raw.result ? 'result' : 'raw';
      console.log('[Chubby Widget] Data source:', source);
      console.log('[Chubby Widget] Data received:', JSON.stringify(data, null, 2).slice(0, 2000));
      // Debug: Log annualSnapshots and firstMonthEvents
      console.log('[Chubby Widget] annualSnapshots:', data.annualSnapshots?.length || 0, 'entries');
      console.log('[Chubby Widget] firstMonthEvents:', Object.keys(data.firstMonthEvents || {}).length, 'ages');
      if (data.traceNote) {
        console.warn('[Chubby Widget] traceNote:', data.traceNote.message);
      }

      if (data.needsInput) {
        renderNeedsInput(data);
        return;
      }

      // Check for error response
      if (data.success === false || data.error) {
        console.error('[Chubby Widget] Error:', data.error);
        document.getElementById('root').classList.remove('is-loading');
        document.getElementById('root').innerHTML = `
          <div class="header">
            <span class="header-brand">Chubby</span>
          </div>
          <div style="padding: var(--space-6); text-align: center;">
            <div style="font-size: var(--font-size-lg); color: var(--color-negative); margin-bottom: var(--space-3);">
              Simulation Error
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-4);">
              ${data.error || 'Unknown error'}
            </div>
            ${data.details ? `<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); font-family: monospace;">
              ${JSON.stringify(data.details)}
            </div>` : ''}
          </div>
        `;
        return;
      }

      // Debug: Log trajectory data specifically
      const trajectory = data.netWorthTrajectory || data.mc?.netWorthTrajectory || [];
      console.log('[Chubby Widget] Trajectory points:', trajectory.length);
      if (trajectory.length > 0) {
        console.log('[Chubby Widget] First point:', JSON.stringify(trajectory[0]));
        console.log('[Chubby Widget] Last point:', JSON.stringify(trajectory[trajectory.length - 1]));
      } else {
        console.warn('[Chubby Widget] No trajectory data! Bars will show 0.');
      }

      // Remove loading state
      document.getElementById('root').classList.remove('is-loading');

      renderDuration(data);
      renderScenario(data);
      renderTrajectory(data);

      // Assumptions - dynamic from widgetData
      renderAssumptions(data);

      // Footer
      const horizonMonths = data.inputs?.horizonMonths || 360;
      const horizonAgeVal = (data.inputs?.currentAge || 35) + Math.floor(horizonMonths / 12);
      // runId removed — unnecessary metadata
      document.getElementById('horizon-age').textContent = horizonAgeVal;
      document.getElementById('paths-run').textContent = data.pathsRun || 100;
      document.getElementById('seed').textContent = data.baseSeed || data.seed || '—';

      // Generate fragment URL for "Share" link
      generateViewerLink(data);
    }

    // =========================================================================
    // Fragment URL (privacy-first — #fragment never sent to servers)
    // =========================================================================

    async function generateViewerLink(d) {
      try {
        var payload = {
          success: d.success,
          inputs: d.inputs,
          mc: d.mc ? {
            finalNetWorthP10: d.mc.finalNetWorthP10,
            finalNetWorthP50: d.mc.finalNetWorthP50,
            finalNetWorthP75: d.mc.finalNetWorthP75,
            runwayP10Months: d.mc.runwayP10Months,
            runwayP50Months: d.mc.runwayP50Months,
            runwayP75Months: d.mc.runwayP75Months,
            runwayP10Age: d.mc.runwayP10Age,
            runwayP50Age: d.mc.runwayP50Age,
            runwayP75Age: d.mc.runwayP75Age,
            runwayP10: d.mc.runwayP10,
            runwayP50: d.mc.runwayP50,
            runwayP75: d.mc.runwayP75,
            constraintProbability: d.mc.constraintProbability,
            netWorthTrajectory: d.mc.netWorthTrajectory,
          } : undefined,
          netWorthTrajectory: d.netWorthTrajectory,
          planDuration: d.planDuration,
          schedule: d.schedule,
          phaseInfo: d.phaseInfo,
          pathsRun: d.pathsRun,
          baseSeed: d.baseSeed,
          startYear: d.startYear,
          annualSnapshots: d.annualSnapshots,
          firstMonthEvents: d.firstMonthEvents,
        };

        var jsonStr = JSON.stringify(payload);
        var blob = new Blob([jsonStr]);
        var cs = new CompressionStream('deflate');
        var compressed = await new Response(blob.stream().pipeThrough(cs)).arrayBuffer();
        var bytes = new Uint8Array(compressed);
        var binary = '';
        for (var i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
        var b64 = btoa(binary);

        var url = 'https://widget.chubby.fyi/viewer#d=' + b64;
        document.getElementById('viewer-link').href = url;
        document.getElementById('viewer-link').style.display = '';
        document.getElementById('viewer-link-sep').style.display = '';
        console.log('[Chubby Widget] Viewer link ready (' + b64.length + ' chars compressed)');
      } catch (err) {
        console.warn('[Chubby Widget] Could not generate viewer link:', err);
      }
    }

    // =========================================================================
    // Copy Summary (ASCII-friendly)
    // =========================================================================

    function generateAsciiSummary() {
      if (!data) return 'No simulation data available.';

      const inp = data.inputs || {};
      const mc = data.mc || {};
      const sch = data.schedule || {};
      const trajectory = data.netWorthTrajectory || mc.netWorthTrajectory || [];
      const currentAge = inp.currentAge || 35;
      const horizonMonths = inp.horizonMonths || 360;
      const endAge = currentAge + Math.floor(horizonMonths / 12);

      // Find max P50 for scaling bars
      let maxP50 = 0;
      trajectory.forEach(pt => {
        const p50 = pt.p50 || 0;
        if (p50 > maxP50) maxP50 = p50;
      });
      if (maxP50 === 0) maxP50 = 1;

      // Build trajectory rows (P10/P50 with bar)
      const rows = [];
      for (let age = currentAge; age <= endAge; age += 5) {
        const yearOffset = age - currentAge;
        const monthOffset = yearOffset * 12;
        let pt = null;
        let minDiff = Infinity;
        trajectory.forEach(p => {
          const diff = Math.abs((p.monthOffset || p.month || 0) - monthOffset);
          if (diff < minDiff) { minDiff = diff; pt = p; }
        });
        if (pt) {
          const p10val = pt.p10 != null ? pt.p10 : 0;
          const p50val = pt.p50 || 0;
          const p75val = pt.p75 != null ? pt.p75 : 0;
          const pctFunded = pt.pctPathsFunded ?? pt.survivalRate;
          const isConst = pctFunded !== undefined ? pctFunded < 0.5 : p50val <= 0;
          // Stop when even P75 hits 0
          if (isConst && p75val <= 0) continue;
          const barLen = Math.round(((isConst ? p75val : p50val) / maxP50) * 12);
          const filled = Math.max(isConst && p75val > 0 ? 1 : 0, barLen);
          const bar = '\u2593'.repeat(filled) + '\u2591'.repeat(12 - filled);
          const depletedSuffix = isConst && pctFunded !== undefined
            ? ' (' + Math.round((1 - pctFunded) * 100) + '% depleted)'
            : '';
          rows.push({
            age,
            val: fmt(Math.max(0, p50val)) + depletedSuffix,
            bar
          });
        }
      }

      // Plan duration text
      const constraintProb = mc.constraintProbability || 0;
      let durationText = 'Stays funded through Age ' + endAge;
      if (constraintProb > 0.5) {
        for (const row of rows) {
          if (row.val.startsWith('$0')) {
            durationText = 'Runs out around Age ' + row.age;
            break;
          }
        }
      }

      // Build plain-text output (no monospace dependency)
      let lines = [
        'PLAN DURATION',
        durationText,
        '',
        'SCENARIO',
        'Age ' + currentAge + ' · ' + fmt(inp.investableAssets) + ' · ' + fmtYr(inp.expectedIncome) + '/yr → ' + fmtYr(inp.annualSpending) + '/yr',
      ];

      // Events
      const events = sch.scheduledEvents || [];
      if (events.length > 0) {
        lines.push('');
        lines.push('EVENTS');
        events.slice(0, 4).forEach(e => {
          lines.push('· Age ' + e.age + ': ' + (e.label || ''));
        });
      }

      // Trajectory with bar visualization
      lines.push('');
      lines.push('TRAJECTORY');
      rows.forEach(r => {
        lines.push('Age ' + r.age + ' ' + r.bar + ' ' + r.val);
      });

      // Footer
      lines.push('');
      lines.push('seed: ' + (data.baseSeed || data.seed || '—') + ' · ' + (data.pathsRun || 100) + ' paths');
      lines.push('chubby.finance');

      return lines.join('\n');
    }

    async function copySummaryToClipboard() {
      const btn = document.getElementById('copy-summary-btn');
      const toast = document.getElementById('copied-toast');
      const summary = generateAsciiSummary();

      const showCopied = () => {
        btn.classList.add('copied');
        toast.classList.add('visible');
        setTimeout(() => {
          btn.classList.remove('copied');
          toast.classList.remove('visible');
        }, 2000);
      };

      try {
        await navigator.clipboard.writeText(summary);
        showCopied();
      } catch (err) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = summary;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopied();
      }
    }

    // =========================================================================
    // Event Handlers
    // =========================================================================

    document.addEventListener('DOMContentLoaded', () => {
      function closeInspector() {
        const inspector = document.getElementById('inspector');
        inspector.classList.remove('visible');
        inspector.setAttribute('aria-hidden', 'true');
        // Return focus to the row that opened the inspector
        if (inspector._triggerEl) {
          inspector._triggerEl.focus();
          inspector._triggerEl = null;
        }
      }

      document.getElementById('inspector-close').addEventListener('click', closeInspector);

      // Escape key closes inspector
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          const inspector = document.getElementById('inspector');
          if (inspector.classList.contains('visible')) {
            e.preventDefault();
            closeInspector();
          }
        }
      });

      document.getElementById('copy-summary-btn').addEventListener('click', copySummaryToClipboard);

      if (window.openai?.toolOutput) init(window.openai.toolOutput);

      window.addEventListener('message', e => {
        if (e.data?.type === 'simulationResult') init(e.data.result);
        if (e.data?.type === 'setVariant') {
          const widget = document.getElementById('root');
          widget.classList.remove('compact', 'ultra-compact');
          if (e.data.variant === 'compact') widget.classList.add('compact');
          if (e.data.variant === 'ultra') widget.classList.add('ultra-compact');
        }
      });

      window.addEventListener('openai:set_globals', e => {
        if (e.detail?.globals?.toolOutput) init(e.detail.globals.toolOutput);
      }, { passive: true });
    });
  </script>
</body>
</html>
